<!-- =========================
     CarrierPalette.html
     ========================= -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>キャリアパレット</title>
  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
      margin:0;background:#f6f7f9;color:#111;font-size:16px;
    }
    body[data-mode="single"] .grid2{ grid-template-columns: 1fr; }
    body[data-mode="single"] .resultGrid{ grid-template-columns: 1fr; }

    :root{
  --header-h: 90px;   /* ← ヘッダーの高さ。必要なら調整 */
}

html, body{
  height:auto;
  overflow:auto;
}

.wrap{
  height: calc(100vh - var(--header-h));
  overflow:auto;
  -webkit-overflow-scrolling: touch;

  max-width:980px;
  margin:0 auto;
  padding:12px 16px 40px;
}
    .card{background:#fff;border:1px solid #e6e8eb;border-radius:14px;padding:12px;}
    .divider{height:1px;background:#eef0f3;margin:10px 0;}
    label{font-size:13px;color:#333;font-weight:900;}
    select,input{
      width:100%;padding:10px 10px;border-radius:10px;border:1px solid #d9dde3;
      font-size:15px;background:#fff;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .row.tight{gap:8px}
    .btn2{
      border:1px solid #d9dde3;background:#fff;color:#111;border-radius:12px;
      padding:12px 14px;font-size:15px;cursor:pointer;
    }
    .hidden{display:none !important;}
    .note{
      background:#f6fbff;border:1px solid #d6e8ff;border-radius:12px;padding:10px 10px;
      color:#234; font-size:13px; line-height:1.4;
    }
    .alert{
      background:#fff5f5;border:1px solid #ffd2d2;border-radius:12px;padding:10px 10px;
      color:#b00020;font-size:14px;font-weight:1000;
    }
    /* ===== ContractNavigator と同じヘッダー ===== */
header{
  padding:16px 16px 8px;
  background:#fff;
  border-bottom:1px solid #e6e8eb;
  position:relative;
  top:0;
  z-index:10;
}

.title{font-size:24px;font-weight:800;}
.sub{font-size:15px;color:#555;margin-top:4px;}

.devBadge{
  position:absolute;
  top:50%;
  left:35%;
  transform:translate(-50%, -50%);

  font-size:15px;
  font-weight:1100;
  letter-spacing:.12em;

  color:#fff;
  background:#d40000;

  padding:7px 16px;
  border-radius:999px;

  pointer-events:none;
}

    .grid2{display:grid;gap:10px;grid-template-columns:1fr 1fr;}
    @media (max-width: 760px){ .grid2{grid-template-columns:1fr;} }

    .grid3{
      display:grid;
      gap:10px;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      align-items:end;
    }
    @media (max-width: 900px){
      .grid3{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 600px){
      .grid3{ grid-template-columns: 1fr; }
    }
    .grid3 select, .grid3 input{
      padding:8px 10px;
      font-size:14px;
      border-radius:10px;
    }

    .talkBox{
  margin-top:8px;
  border:1px solid #e6e8eb;
  border-radius:14px;
  padding:10px;
  background:#f8fafc;        /* 通話だけ薄く色付け */
}
.talkBoxTitle{
  font-size:12px;
  font-weight:1100;
  color:#334155;
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}
.talkBoxTitle .tag{
  font-size:11px;
  font-weight:1000;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid #d9dde3;
  background:#fff;
  color:#475569;
}
.talkRow{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}

.pillSelect{
  appearance:none;
  -webkit-appearance:none;
  -moz-appearance:none;
  display:inline-flex;
  align-items:center;
  border:1px solid #b7e4c7;
  background:#f3fff7;
  color:#0f5132;
  border-radius:999px;
  padding:8px 34px 8px 12px;
  font-size:13px;
  font-weight:900;
  line-height:1.2;
  cursor:pointer;
  position:relative;
  vertical-align:middle;
}
.pillSelectWrap{
  position:relative;
  display:inline-flex;
  align-items:center;
}
.pillSelectWrap::after{
  content:"▾";
  position:absolute;
  right:12px;
  top:50%;
  transform:translateY(-50%);
  color:#0f5132;
  font-size:12px;
  pointer-events:none;
  opacity:0.8;
  line-height:1;
}
.pillSelect:disabled{
  opacity:0.45;
  cursor:not-allowed;
}

.switchRow{ display:flex; align-items:center; gap:8px; }
.switchLabel{ font-size:12px; color:#64748b; font-weight:1000; }
.switch{
  width:46px; height:26px;
  border-radius:999px;
  background:#e9ecef;
  border:1px solid #d9dde3;
  position:relative;
  cursor:pointer;
}
.switch .knob{
  width:22px; height:22px;
  border-radius:999px;
  background:#16a34a;
  position:absolute;
  top:1px; left:1px;
  transition: transform 160ms ease;
}
.switch[aria-pressed="true"]{
  background:#dcfce7;
  border-color:#86efac;
}
.switch[aria-pressed="true"] .knob{
  transform: translateX(20px);
}

    .sectionTitle{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-top:2px;
    }
    .sectionTitle b{font-size:14px;}
    .mini{font-size:12px;color:#555;line-height:1.35;margin-top:6px;}

    .pillRow{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
    .pill{
      border:1px solid #d9dde3;background:#fff;border-radius:999px;
      padding:8px 12px;font-size:13px;font-weight:900;cursor:pointer;user-select:none;
    }
    .pill.on{background:#111;color:#fff;border-color:#111;}
    .pill.gray{background:#f3f4f6;border-color:#e5e7eb;color:#111;font-weight:800;}
    .pill.warn{background:#fff5f5;border-color:#ffd2d2;color:#b00020;}

    .pill.disc{
      border-color:#b7e4c7;
      background:#f3fff7;
      color:#0f5132;
    }
    .pill.disc.on{
      background:#198754;
      border-color:#198754;
      color:#fff;
    }

    .resultGrid{display:grid;gap:10px;grid-template-columns:1fr 1fr;}
    @media (max-width: 760px){ .resultGrid{grid-template-columns:1fr;} }

    .resultCard{
      border:1px solid #e6e8eb;border-radius:14px;padding:10px 10px;background:#fff;
    }
    .resultTop{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .brand{font-size:14px;font-weight:1000;}
    .price{font-size:28px;font-weight:1100;letter-spacing:0.02em;margin-top:6px;}

    .delta{
      text-align:center;border-radius:14px;border:1px dashed #cbd5e1;background:#f8fafc;padding:10px;margin-top:10px;
    }
    .delta b{font-size:16px;}

    .breakdown{
      margin-top:6px;font-size:12px;
      padding:8px 10px;
      border-radius:12px;
      background:#f8fafc;
      border:1px solid #e6e8eb;
      color:#333;line-height:1.45;
    }
    .breakdown .k{color:#555;}
    .breakdown .line{display:flex;justify-content:space-between;gap:10px;}
    .breakdown .line + .line{margin-top:4px;}

    details.compact{
      border:1px solid #eef0f3;
      border-radius:12px;
      padding:8px 10px;
      margin-top:10px;
      background:#fafafa;
    }
    details.compact summary{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
      font-weight:1000;
      font-size:13px;
    }
    .badgeMini{
      font-size:11px;
      font-weight:900;
      border:1px solid #e6e8eb;
      background:#fff;
      border-radius:999px;
      padding:4px 8px;
      color:#555;
      flex:0 0 auto;
      white-space:nowrap;
    }

    .carrierGrid{
      display:grid;
      gap:10px;
      grid-template-columns: 1fr;
    }
    .carrierGrid.compare{
      grid-template-columns: 1fr 1fr;
    }
    @media (max-width: 760px){
      .carrierGrid.compare{ grid-template-columns: 1fr; }
    }

    .carrierList{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:8px;
    }
    @media (max-width: 760px){
      .carrierList{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .carrierCard{
      padding:8px;
      border:1px solid #e6e8eb;
      border-radius:12px;
      background:#fff;
      cursor:pointer;
      user-select:none;
      position:relative;
    }
    .carrierCard.on{
      border-color:#111;
      background:#d8dff8;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }
    .carrierHeroImg{
      width:100%;
      height:96px;
      border-radius:10px;
      object-fit:cover;
      display:block;
      border:1px solid #e6e8eb;
      background:#f3f4f6;
    }

    .carrierCard:not(.on) .carrierHeroImg{
      filter: grayscale(100%);
      opacity: 0.55;
    }
    .carrierCard:not(.on)::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius:12px;
      background: rgba(220,220,220,0.35);
      pointer-events:none;
    }
    .carrierCard:not(.on) .carrierCompareImg{
      filter: grayscale(100%);
      opacity: 0.55;
    }
    .carrierCard.on::after{ display:none; }

    .carrierGrid.compare .carrierCard{
      aspect-ratio: 1 / 1;
      padding: 8px;
      display: grid;
      place-items: center;
    }
    .carrierGrid.compare .carrierCompareImg{
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }
    .carrierGrid:not(.compare) .carrierCompareImg{ display:none; }
    .carrierGrid.compare .carrierHeroImg{ display:none; }

    #recPills{ display:none !important; }

    /* ===== one-button toggle ===== */
    .modeSwitch{
      display:flex; align-items:center; gap:10px;
      user-select:none;
      padding:10px 12px;
      border:1px solid #d9dde3;
      border-radius:14px;
      background:#fff;
      cursor:pointer;
    }
    .modeLabel{
      font-size:13px;
      font-weight:1000;
      color:#555;
    }
    body[data-mode="single"] #modeLabelLeft,
    body[data-mode="compare"] #modeLabelRight{
      color:#111;
    }
    .modeTrack{
      width:46px; height:26px;
      border-radius:999px;
      background:#e9ecef;
      position:relative;
      flex:0 0 auto;
      border:1px solid #d9dde3;
    }
    .modeThumb{
      width:22px; height:22px;
      border-radius:999px;
      background:#16a34a;
      position:absolute;
      top:1px; left:1px;
      transition: transform 160ms ease;
    }
    body[data-mode="compare"] .modeThumb{
      transform: translateX(20px);
    }
    body[data-mode="compare"] .modeTrack{
      background:#dcfce7;
      border-color:#86efac;
    }

.appSwitch{
  position:fixed;
  right:18px;
  bottom:18px;
  display:flex;
  gap:14px;
  z-index:9999;
}

.appSwitch a{
  width:64px;
  height:64px;
  display:grid;
  place-items:center;
  border-radius:22px;
  border:1px solid #d9dde3;
  background:#fff;
  text-decoration:none;
  box-shadow: 0 10px 26px rgba(0,0,0,0.18);
  font-size:30px;   /* ← アイコン大きく */
  user-select:none;
  -webkit-tap-highlight-color: transparent;
  transition: all 120ms ease;
}

.appSwitch a.on{
  border-color:#111;
  box-shadow: 0 12px 30px rgba(0,0,0,0.22);
}

.appSwitch a:active{
  transform: translateY(2px) scale(0.97);
}
  </style>
</head>

<body>
  <header>
  <div class="title">キャリアパレット</div>
  <div class="sub">料金比較・見積り</div>

  <!-- 開発中バッジ（契約ナビと同じ位置・見た目） -->
  <div class="devBadge">⚠ 開発中 ⚠</div>

  <!-- もともと右側にあったモード切替はヘッダー内に残す -->
  <div class="modeSwitch" id="modeToggle" role="button" aria-label="表示モード切替" tabindex="0"
       style="position:absolute; right:16px; top:50%; transform:translateY(-50%);">
    <span class="modeLabel" id="modeLabelLeft">単体</span>
    <span class="modeTrack" aria-hidden="true">
      <span class="modeThumb" id="modeThumb"></span>
    </span>
    <span class="modeLabel" id="modeLabelRight">比較</span>
  </div>
</header>
  <div class="wrap">
    <div class="card">
    <div class="divider"></div>
    <div class="sectionTitle"><b></b></div>

    <div class="carrierGrid" id="carrierGrid">
      <div class="resultCard">
        <select id="carrierA" class="hidden">
          <option value="" selected>未選択</option>
          <option value="docomo">docomo</option>
          <option value="ahamo">ahamo</option>
          <option value="au">au</option>
          <option value="uq">UQ mobile</option>
          <option value="softbank">SoftBank</option>
          <option value="ymobile">Y!mobile</option>
        </select>
        <div id="carrierCardsA" class="carrierList"></div>
      </div>

      <div class="resultCard hidden" id="carrierBBlock">
        <select id="carrierB" class="hidden">
          <option value="" selected>未選択</option>
          <option value="docomo">docomo</option>
          <option value="ahamo">ahamo</option>
          <option value="au">au</option>
          <option value="uq">UQ mobile</option>
          <option value="softbank">SoftBank</option>
          <option value="ymobile">Y!mobile</option>
        </select>
        <div id="carrierCardsB" class="carrierList"></div>
      </div>
    </div>

    <div class="divider"></div>
    <div class="sectionTitle"><b>オプション / 割引</b></div>

    <div class="grid2" style="margin-top:8px;">
      <!-- A -->
      <div class="resultCard">
        <div class="resultTop">
          <div class="brand" id="optTitleA">A：—</div>
        </div>

        <div style="margin-top:8px;">
          <label>プラン</label>
          <select id="A_planSelect"></select>
        </div>

        <div class="divider" style="margin:10px 0;"></div>
        <div class="talkBox">
        <div class="talkBoxTitle">
          <span>通話オプション</span>
          <div class="switchRow">
            <span class="switchLabel">なし</span>
            <button class="switch" id="A_talkSwitch" type="button" aria-pressed="false">
              <span class="knob"></span>
            </button>
            <span class="switchLabel">あり</span>
          </div>
        </div>

        <div class="talkRow" id="A_talkKinds" style="margin-top:8px;">
          <div class="pill" id="A_kind_short">短時間かけ放題</div>
          <div class="pill" id="A_kind_unlimited">かけ放題</div>
          <div class="pill" id="A_kind_senior">かけ放題(60歳以上)</div>
          <div class="pill" id="A_kind_min60">1ヶ月60分</div>
        </div>
      </div>

      <div class="pillRow" style="margin-top:6px;">
          <div class="pill" id="A_mail">メール持ち運び</div>
      </div>

        <div class="divider" style="margin:10px 0;"></div>
        <div class="mini" style="margin:0;font-weight:1000;">割引</div>
        <div class="pillRow" style="margin-top:6px;">
          <div class="pill disc" id="A_aupay">auPAYカード割</div>
          <div class="pill disc" id="A_dcardPill">dカード割</div>
          <span class="pillSelectWrap hidden" id="A_dcardWrap">
            <select id="A_dcard" class="pillSelect">
              <option value="silver">シルバー</option>
              <option value="gold">ゴールド</option>
            </select>
          </span> 
          <div class="pill disc" id="A_hikari">光割</div>
                    <div class="pill disc" id="A_family">家族割</div>
          <span class="pillSelectWrap" id="A_familyCountWrap">
            <select id="A_familyCount" class="pillSelect">
              <option value="2">2回線</option>
              <option value="3">3回線以上</option>
            </select>
          </span>
                    <div class="pill disc" id="A_oyako">親子割</div>
          <div class="pill disc" id="A_support39">39割</div>
          <div class="pill disc" id="A_denki">でんき割</div>         
        </div>

        <details class="compact" id="A_customBox">
          <summary>
            <span>任意調整</span>
            <span class="badgeMini" id="A_customBadge">未設定</span>
          </summary>

          <div class="row tight" style="margin-top:8px;">
            <input id="A_customDiscountYen" type="number" step="10" style="max-width:180px;" placeholder="例）-1000 / +330">
            <div style="font-size:13px;color:#555;font-weight:900;">円 / 月</div>
          </div>
          <input id="A_customDiscountNote" type="text" placeholder="メモ（任意）" style="margin-top:6px;">
          <div class="mini">※マイナスは割引、プラスは追加料金扱い</div>
        </details>
      </div>

      <!-- B -->
      <div class="resultCard hidden" id="optBlockB">
        <div class="resultTop">
          <div class="brand" id="optTitleB">B：—</div>
        </div>

        <div style="margin-top:8px;">
          <label>プラン</label>
          <select id="B_planSelect"></select>
        </div>

        <div class="divider" style="margin:10px 0;"></div>
        <div class="talkBox">
        <div class="talkBoxTitle">
          <span>通話オプション</span>
          <div class="switchRow">
            <span class="switchLabel">なし</span>
            <button class="switch" id="B_talkSwitch" type="button" aria-pressed="false">
              <span class="knob"></span>
            </button>
            <span class="switchLabel">あり</span>
          </div>
        </div>

        <div class="talkRow" id="B_talkKinds" style="margin-top:8px;">
          <div class="pill" id="B_kind_short">短時間かけ放題</div>
          <div class="pill" id="B_kind_unlimited">かけ放題</div>
          <div class="pill" id="B_kind_senior">かけ放題(60歳以上)</div>
          <div class="pill" id="B_kind_min60">1ヶ月60分</div>
          
        </div>
      </div>

        <div class="pillRow" style="margin-top:6px;">
          <div class="pill" id="B_mail">メール持ち運び</div>
        </div>

        <div class="divider" style="margin:10px 0;"></div>
        <div class="mini" style="margin:0;font-weight:1000;">割引</div>
        <div class="pillRow" style="margin-top:6px;">
          <div class="pill disc" id="B_aupay">auPAYカード割</div>
          <div class="pill disc" id="B_dcardPill">dカード割</div>
            <span class="pillSelectWrap hidden" id="B_dcardWrap">
              <select id="B_dcard" class="pillSelect">
                <option value="silver">シルバー</option>
                <option value="gold">ゴールド</option>
              </select>
            </span>
          <div class="pill disc" id="B_hikari">光割</div>
          <div class="pill disc" id="B_family">家族割</div>
          <span class="pillSelectWrap" id="B_familyCountWrap">
            <select id="B_familyCount" class="pillSelect">
              <option value="2">2回線</option>
              <option value="3">3回線以上</option>
            </select>
          </span>
          <div class="pill disc" id="B_oyako">親子割</div>
          <div class="pill disc" id="B_support39">39割</div>
          <div class="pill disc" id="B_denki">でんき割</div>  
        </div>

        <details class="compact" id="B_customBox">
          <summary>
            <span>任意調整</span>
            <span class="badgeMini" id="B_customBadge">未設定</span>
          </summary>

          <div class="row tight" style="margin-top:8px;">
            <input id="B_customDiscountYen" type="number" step="10" style="max-width:180px;" placeholder="例）-1000 / +330">
            <div style="font-size:13px;color:#555;font-weight:900;">円 / 月</div>
          </div>
          <input id="B_customDiscountNote" type="text" placeholder="メモ（任意）" style="margin-top:6px;">
          <div class="mini">※マイナスは割引、プラスは追加料金扱い</div>
        </details>
      </div>
    </div>

    <!-- 結果 -->
    <div class="divider"></div>
    <div class="sectionTitle"><b>月額合計（目安）</b></div>

    <div class="resultGrid" style="margin-top:8px;">
      <div class="resultCard" id="resultA">
        <div class="resultTop">
          <div class="brand" id="brandA">A：未選択</div>
        </div>
        <div class="price" id="priceA">—</div>
        <div class="mini" style="margin-top:8px;font-weight:900;">内訳</div>
        <div class="breakdown" id="bdA"></div>
      </div>

      <div class="resultCard hidden" id="resultB">
        <div class="resultTop">
          <div class="brand" id="brandB">B：未選択</div>
        </div>
        <div class="price" id="priceB">—</div>
        <div class="mini" style="margin-top:8px;font-weight:900;">内訳</div>
        <div class="breakdown" id="bdB"></div>
      </div>
    </div>

    <details class="compact hidden" id="deltaBox">
  <summary>
    <span class="badgeMini" id="deltaBadge">差額を表示</span>
  </summary>
  <div class="delta" style="margin-top:10px;">
    <div><b id="deltaText">差額：—</b></div>
  </div>
</details>

    <div class="alert hidden" id="pointAlert" style="margin-top:10px;"></div>
    <div class="alert hidden" id="priceDbAlert" style="margin-top:10px;"></div>
  </div>

  <script src="data.js"></script>
  <script>
  const STORAGE_KEY = "contract_navi_ctx_v2_multi";
  const el = (id) => document.getElementById(id);

  const on = (id, ev, fn) => { const x = el(id); if (x) x.addEventListener(ev, fn); };
  const click = (id, fn) => { const x = el(id); if (x) x.onclick = fn; };

  const CARRIER_ICON = {
    docomo:   "icons/docomo_H.png",
    ahamo:    "icons/ahamo_H.png",
    au:       "icons/au_H.png",
    uq:       "icons/uq_H.png",
    softbank: "icons/sb_H.png",
    ymobile:  "icons/y_H.png",
  };
  const CARRIER_COMPARE = {
    docomo:   "icons/docomo_C.png",
    ahamo:    "icons/ahamo_C.png",
    au:       "icons/au_C.png",
    uq:       "icons/uq_C.png",
    softbank: "icons/sb_C.png",
    ymobile:  "icons/y_C.png",
  };
  const CARRIER_ORDER = ["docomo","au","softbank","ahamo","uq","ymobile"];

  function carrierLabel(v){
    return ({
      docomo:"docomo", ahamo:"ahamo", au:"au", uq:"UQ mobile",
      softbank:"SoftBank", ymobile:"Y!mobile"
    })[v] || v || "未選択";
  }

  function yen(n){
    if (!Number.isFinite(n)) return "—";
    return "¥" + Math.round(n).toLocaleString("ja-JP");
  }

  function readShared(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return {};
    try { return JSON.parse(raw) || {}; } catch(e){ return {}; }
  }
  function writeSharedAll(obj){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
    return obj;
  }
  function needsDeviceFlow(ct){
    return ct === "deviceChange" || ct === "mnpDevice" || ct === "new";
  }
  function getActiveLine(shared){
    const lines = Array.isArray(shared.lines) ? shared.lines : [];
    const active = Number.isFinite(shared.activeLine) ? shared.activeLine : 0;
    const idx = Math.max(0, Math.min(active, Math.max(0, lines.length - 1)));
    const line = lines[idx] || { form:{}, consult:{} , flow:{} };
    line.consult = line.consult || {};
    return { idx, line, lines };
  }
  function saveConsultPatch(patch){
    const s = readShared();
    const t = getActiveLine(s);
    t.line.consult = { ...(t.line.consult || {}), ...patch };
    s.lines = Array.isArray(s.lines) ? s.lines : [];
    s.lines[t.idx] = t.line;
    writeSharedAll(s);
  }
  function loadCtx(){
    const s = readShared();
    const { line } = getActiveLine(s);
    const form = line.form || {};
    const consult = line.consult || {};
    return { s, line, form, consult };
  }

  function updatePointAlert(){
    const box = el("pointAlert");
    if (!box) return;

    const { form, consult } = loadCtx();
    const ct = form.contractType || "";

    if (ct !== "mnpDevice") {
      box.classList.add("hidden");
      box.textContent = "";
      return;
    }

    const payType = (el("payType") ? el("payType").value : "") || (consult.payType || "");
    const tradeIn = (el("needTradeInReception") ? el("needTradeInReception").value : "no") || (consult.needTradeInReception || "no");

    const isCarrierOrLump = (payType === "carrierInstall" || payType === "lump");
    const noTradeIn = (tradeIn === "no");

    if (isCarrierOrLump && noTradeIn){
      box.textContent = "【注意】購入方法が「分リセ以外」かつ「下取りなし」の場合、ポイント付与ができません。下取り受付をご確認ください。";
      box.classList.remove("hidden");
    } else {
      box.classList.add("hidden");
      box.textContent = "";
    }
  }

  function getKey(side, name){ return `${side}_${name}`; }
  function getConsult(consult, side, name, def){
    const k = getKey(side, name);
    return (k in consult) ? consult[k] : def;
  }
  function setConsultPatch(side, patch){
    const out = {};
    Object.keys(patch).forEach(name=>{
      out[getKey(side,name)] = patch[name];
    });
    saveConsultPatch(out);
  }

  function readMode(){
    const { consult } = loadCtx();
    return consult.viewMode === "compare" ? "compare" : "single";
  }
  function setMode(mode){
    saveConsultPatch({ viewMode: (mode === "compare" ? "compare" : "single") });
  }

  /* ===== UQ: 家族割と光割は併用不可（光割優先） ===== */
  function enforceUqDiscountRule(side, carrier, consult){
    if (carrier !== "uq") return;
    const famOn = !!getConsult(consult, side, "discFamily", false);
    const hikOn = !!getConsult(consult, side, "discHikari", false);
    if (famOn && hikOn){
      setConsultPatch(side, { discFamily:false, discHikari:true });
    }
  }
  function toggleDiscountWithUqRule(side, carrier, kind){
    const { consult } = loadCtx();
    const famOn = !!getConsult(consult, side, "discFamily", false);
    const hikOn = !!getConsult(consult, side, "discHikari", false);

    if (carrier !== "uq"){
      if (kind === "family") setConsultPatch(side, { discFamily: !famOn });
      else if (kind === "hikari") setConsultPatch(side, { discHikari: !hikOn });
      else if (kind === "aupay"){
        const cur = !!getConsult(consult, side, "discAupay", false);
        setConsultPatch(side, { discAupay: !cur });
      }
      return;
    }

    if (kind === "hikari"){
      const next = !hikOn;
      setConsultPatch(side, { discHikari: next, discFamily: next ? false : famOn });
    } else if (kind === "family"){
      if (hikOn){
        setConsultPatch(side, { discFamily:false, discHikari:true });
      } else {
        setConsultPatch(side, { discFamily: !famOn, discHikari:false });
      }
    } else if (kind === "aupay"){
      const cur = !!getConsult(consult, side, "discAupay", false);
      setConsultPatch(side, { discAupay: !cur });
    }
  }

  function renderCarrierCards(side){
    const host = el(side === "A" ? "carrierCardsA" : "carrierCardsB");
    if (!host) return;

    const sel = el(side === "A" ? "carrierA" : "carrierB");
    const current = sel ? sel.value : "";
    const mode = readMode();

    host.innerHTML = "";

    CARRIER_ORDER.forEach(key=>{
      const card = document.createElement("div");
      card.className = "carrierCard" + (current === key ? " on" : "");

      if (mode === "single"){
        const img = document.createElement("img");
        img.className = "carrierHeroImg";
        img.src = CARRIER_ICON[key] || "";
        img.alt = carrierLabel(key);
        card.appendChild(img);
      } else {
        const img = document.createElement("img");
        img.className = "carrierCompareImg";
        img.src = CARRIER_COMPARE[key] || "";
        img.alt = carrierLabel(key);
        card.appendChild(img);
      }

      card.onclick = () => {
        if (sel) sel.value = key;
        saveConsultPatch(side === "A" ? { carrierA:key } : { carrierB:key });

        // キャリア切替で状態が残留しないように初期化（A/B共通）
        const isAhamo = (key === "ahamo");

        setConsultPatch(side, {
          planKey: "",
          discFamily:false, discHikari:false, discOyako:false, discAupay:false,
          talkEnabled: isAhamo ? true : false,
          talkKind: "short",
        });

        renderAll();
      };

      host.appendChild(card);
    });
  }

  function pillSet(elm, on){
    if (!elm) return;
    elm.classList.toggle("on", !!on);
  }

  // 「短時間かけ放題」表示（キャリアで 5/10 を出し分け）
  function shortTalkLabel(carrier, planKey){
    // ahamo / docomo は 5分
    if (carrier === "docomo" || carrier === "ahamo") return "5分以内";

    // UQ：コミコミは 10分付帯だが、表示は同じでOK
    if (carrier === "uq") return "10分以内";

    // ymobile/sb/au は 10分想定
    return "10分以内";
  }

  function updateCustomBadge(side, consult){
    const v = Number(getConsult(consult, side, "customDiscountYen", 0) || 0) || 0;
    const note = (getConsult(consult, side, "customDiscountNote", "") || "").trim();
    const badge = el(side + "_customBadge");
    if (!badge) return;

    if (v === 0 && !note){
      badge.textContent = "未設定";
    } else {
      const vv = (v > 0 ? "+" : "") + Math.round(v) + "円";
      badge.textContent = vv + (note ? " / メモ" : "");
    }
  }

  function renderBreakdown(targetId, lines){
    const box = el(targetId);
    if (!box) return;
    box.innerHTML = "";
    (lines || []).forEach(it => {
      const row = document.createElement("div");
      row.className = "line";
      const k = document.createElement("div");
      k.className = "k";
      k.textContent = it.k;
      const v = document.createElement("div");
      v.textContent = yen(it.v);
      row.appendChild(k); row.appendChild(v);
      box.appendChild(row);
    });
  }

  function showPriceDbAlert(msg){
    const box = el("priceDbAlert");
    if (!box) return;
    if (!msg){
      box.classList.add("hidden");
      box.textContent = "";
      return;
    }
    box.textContent = msg;
    box.classList.remove("hidden");
  }

  function needsFamilyCount(carrier, planKey){
  if (carrier === "au" || carrier === "softbank") return true;

  if (carrier === "docomo"){
    // ドコモMAXの planKey 命名に合わせて調整してOK
    // 例: "docomo_max" / "max" / "irumo_max" など
    return String(planKey || "").toLowerCase().includes("max");
  }
  return false;
}

function applyFamilyCountUI(side, carrier, consult){
  const planKey = getConsult(consult, side, "planKey", "");
  const famOn = !!getConsult(consult, side, "discFamily", false);

  const wrap = el(side + "_familyCountWrap");
  const sel  = el(side + "_familyCount");
  if (!wrap || !sel) return;

  // UQ: 光割ONなら家族回線数は不要（非表示）
  const hikOn = (carrier === "uq") && !!getConsult(consult, side, "discHikari", false);
  if (hikOn){
    wrap.classList.add("hidden");
    sel.disabled = true;
    return;
  }

  const need = needsFamilyCount(carrier, planKey);
  wrap.classList.toggle("hidden", !need);

  if (!need) return;

  // 家族割ONのときだけ触れる
  sel.disabled = !famOn;

  // ★discFamilyCount は 2 or 3 に正規化（4などが残ってても3へ）
  let cur = Number(getConsult(consult, side, "discFamilyCount", 2) || 2) || 2;
  cur = (cur >= 3) ? 3 : 2;

  // UI反映
  sel.value = String(cur);

  // 保存値も正規化しておく（localStorageに4が残る事故を潰す）
  if (Number(getConsult(consult, side, "discFamilyCount", 2) || 2) !== cur){
    setConsultPatch(side, { discFamilyCount: cur });
  }
}

  function syncPlanSelect(side, carrier, form, consult){
    const sel = el(side + "_planSelect");
    if (!sel) return;

    if (!window.PRICE_DB){
      sel.innerHTML = "<option value=''>data.js（PRICE_DB）が読み込めていません</option>";
      sel.disabled = true;
      showPriceDbAlert("【エラー】data.js が読み込めていないか、PRICE_DB が未定義です。ファイル名・パス・読み込み順を確認してください。");
      return;
    } else {
      showPriceDbAlert("");
    }

    const c = window.PRICE_DB.getCarrier ? window.PRICE_DB.getCarrier(carrier) : null;
    sel.innerHTML = "";

    if (!carrier || !c || !c.plans){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "キャリアを選択してください";
      sel.appendChild(opt);
      sel.disabled = true;
      return;
    }
    sel.disabled = false;

    const savedKey = getConsult(consult, side, "planKey", "");
    const fallback = window.PRICE_DB.getDefaultPlanKey ? window.PRICE_DB.getDefaultPlanKey(carrier, form.dataUsage || "lte30") : "";
    const currentKey =
      (savedKey && c.plans[savedKey]) ? savedKey :
      (fallback && c.plans[fallback]) ? fallback : "";

    Object.keys(c.plans).forEach(k=>{
      const p = c.plans[k];
      const opt = document.createElement("option");
      opt.value = k;
      opt.textContent = p.label;
      sel.appendChild(opt);
    });

    sel.value = currentKey || Object.keys(c.plans)[0] || "";
    setConsultPatch(side, { planKey: sel.value });
  }

  function applyDiscountEligibilityUI(side, carrier, consult){
    if (!window.PRICE_DB) return;

    const planKey = getConsult(consult, side, "planKey", "");
    const famBtn = el(side + "_family");
    const hikBtn = el(side + "_hikari");
    const apyBtn = el(side + "_aupay");
    const oyaBtn = el(side + "_oyako");
    const s39Btn = el(side + "_support39");
    const denBtn  = el(side + "_denki");
    const dcdPill = el(side + "_dcardPill"); 

    // UQコミコミは割引なし → pillを隠す（トクトクは表示）
    const uqNoDiscount = (carrier === "uq" && planKey === "komikomi_value");

    const applyOne = (btn, kind, stateKey) => {
      if (!btn) return;

      // ahamoは割引なし（従来通り隠す）
      if (carrier === "ahamo"){
        btn.classList.add("hidden");
        if (getConsult(consult, side, stateKey, false)) setConsultPatch(side, { [stateKey]: false });
        return;
      }

      const ok = window.PRICE_DB.isDiscountEligible ? window.PRICE_DB.isDiscountEligible(carrier, kind, planKey) : true;
      btn.classList.toggle("hidden", !ok);
      if (!ok && getConsult(consult, side, stateKey, false)){
        setConsultPatch(side, { [stateKey]: false });
      }
    };

    applyOne(famBtn, "family", "discFamily");
    applyOne(hikBtn, "hikari", "discHikari");
    applyOne(apyBtn, "aupay",  "discAupay");
    applyOne(oyaBtn, "oyako",  "discOyako");
    applyOne(s39Btn, "support39", "discSupport39");
    applyOne(denBtn, "denki", "discDenki");

    if (carrier === "uq"){
    const hikOn = !!getConsult(consult, side, "discHikari", false);
    const famWrap = el(side + "_familyCountWrap");

    if (hikOn){
      // 表示を消す
      famBtn && famBtn.classList.add("hidden");
      famWrap && famWrap.classList.add("hidden");

      // 状態もOFFに寄せる（事故防止）
      if (getConsult(consult, side, "discFamily", false)){
        setConsultPatch(side, { discFamily:false });
      }
    }
  }
}

  function enforceDefaultsAfterPlan(side, carrier, consult){
      const planKey = getConsult(consult, side, "planKey", "");
      // 「まだ未設定」のときだけ初期値を入れる
      const enabledExists = (getKey(side, "talkEnabled") in consult);
      const kindExists    = (getKey(side, "talkKind") in consult);

      // UQコミコミ：初期は short(=10分内包) を入れるが、ユーザー選択は尊重する
      if (carrier === "uq" && planKey === "komikomi_value"){
        if (!enabledExists || !kindExists){
          setConsultPatch(side, { talkEnabled:true, talkKind:"short" });
        }
        return;
      }

      // ahamo：初期は short(=5分内包) を入れるが、ユーザー選択は尊重する
      if (carrier === "ahamo"){
        if (!enabledExists || !kindExists){
          setConsultPatch(side, { talkEnabled:true, talkKind:"short" });
        }
        return;
      }
}

function isUqKomikomi(carrier, consult, side){
  if (carrier !== "uq") return false;
  const planKey = getConsult(consult, side, "planKey", "");
  return planKey === "komikomi_value";
}

function forceKomikomiTalkOn(side){
  // コミコミは通話内包（short）前提：必ずON+shortへ
  setConsultPatch(side, { talkEnabled:true, talkKind:"short" });
}

function isAhamo(carrier){ return carrier === "ahamo"; }

function forceAhamoTalkOn(side){
  setConsultPatch(side, { talkEnabled:true, talkKind:"short" });
}

function applyDcardUI(side, carrier, consult){
  const pill = el(side + "_dcardPill");
  const wrap = el(side + "_dcardWrap");
  const sel  = el(side + "_dcard");
  if (!pill || !wrap || !sel) return;

  const on = !!getConsult(consult, side, "discDcard", false);

  // docomo 以外は非表示＆OFF（事故防止）
  if (carrier !== "docomo"){
    pill.classList.add("hidden");
    wrap.classList.add("hidden");
    if (on) setConsultPatch(side, { discDcard:false, dcardKind:"silver" });
    return;
  }

  pill.classList.remove("hidden");
  pillSet(pill, on);

  wrap.classList.toggle("hidden", !on);
  sel.disabled = !on;

  const kind = getConsult(consult, side, "dcardKind", "silver") || "silver";
  sel.value = (kind === "gold") ? "gold" : "silver";
}

  function calcMonthly(carrier, form, consult, side){
    console.log("[DBG]", { side, carrier,
  planKey: getConsult(consult, side, "planKey", ""),
  discHikari: getConsult(consult, side, "discHikari", false),
  discFamily: getConsult(consult, side, "discFamily", false),
  discFamilyCount: getConsult(consult, side, "discFamilyCount", 2),
  consultCarrierA: consult.carrierA,
  selCarrierA: el("carrierA")?.value,
});
  if (!carrier) return { total: NaN, lines: [] };
  if (!window.PRICE_DB) return { total: NaN, lines: [] };

  const dataUsage = form.dataUsage || "lte30";

  const chosenKey = getConsult(consult, side, "planKey", "");
  const fallbackKey = window.PRICE_DB.getDefaultPlanKey
    ? window.PRICE_DB.getDefaultPlanKey(carrier, dataUsage)
    : "";

  const carrierObj = window.PRICE_DB.getCarrier ? window.PRICE_DB.getCarrier(carrier) : null;
  const plans = carrierObj?.plans || {};

  const chosenOk = !!(chosenKey && plans[chosenKey]);
  const fallbackOk = !!(fallbackKey && plans[fallbackKey]);

  const planKey =
    chosenOk ? chosenKey :
    fallbackOk ? fallbackKey :
    (Object.keys(plans)[0] || "");

  const plan = window.PRICE_DB.getPlan ? window.PRICE_DB.getPlan(carrier, planKey) : null;
  const base = plan ? plan.price : 0;

  // ===== talk (2-step: enabled + kind) =====
  const talkEnabled = !!getConsult(consult, side, "talkEnabled", false);
  const talkKind = getConsult(consult, side, "talkKind", "short"); // short|unlimited|min60|senior
  let talkYen = 0;

  const includesCallShort = !!(plan?.includes?.callShort);
  const includesMinutes = Number(plan?.includes?.callShortMinutes || 0) || 0;

  if (talkEnabled){
    if (talkKind === "short"){
      // 内包(ahamo=5分, UQコミコミ=10分など)なら追加0円
      if (!includesCallShort){
        const v = window.PRICE_DB.getVoice ? window.PRICE_DB.getVoice(carrier, "short") : null;
        talkYen = v ? v.price : 0;
      } else {
        talkYen = 0;
      }
    } else if (talkKind === "unlimited"){
      const v = window.PRICE_DB.getVoice ? window.PRICE_DB.getVoice(carrier, "unlimited") : null;
      talkYen = v ? v.price : 0;
    } else if (talkKind === "min60"){
      const v = window.PRICE_DB.getVoice ? window.PRICE_DB.getVoice(carrier, "min60") : null;
      talkYen = v ? v.price : 0;
    } else if (talkKind === "senior"){
      const v = window.PRICE_DB.getVoice ? window.PRICE_DB.getVoice(carrier, "senior") : null;
      talkYen = v ? v.price : 0;
    }
  }

  // ===== discounts (eligibility) =====
  let family = 0;
  if (getConsult(consult, side, "discFamily", false) &&
      window.PRICE_DB.isDiscountEligible &&
      window.PRICE_DB.isDiscountEligible(carrier, "family", planKey, {
        discHikari: getConsult(consult, side, "discHikari", false)
      })) {

    const d = window.PRICE_DB.getDiscount
      ? window.PRICE_DB.getDiscount(carrier, "family", {
          discFamilyCount: getConsult(consult, side, "discFamilyCount", 2),
          planKey
        })
      : null;

    family = d ? d.amount : 0;
  }

  let hikari = 0;
  if (getConsult(consult, side, "discHikari", false) &&
      window.PRICE_DB.isDiscountEligible && window.PRICE_DB.isDiscountEligible(carrier, "hikari", planKey)){
    const d = window.PRICE_DB.getDiscount ? window.PRICE_DB.getDiscount(carrier, "hikari") : null;
    hikari = d ? d.amount : 0;
  }
  let oyako_now = 0; let oyako_after = 0;

  const oyakoOn = !!getConsult(consult, side, "discOyako", false);
  const isTokutoku = (carrier === "uq" && String(planKey||"").startsWith("tokutoku_"));
  if (oyakoOn && isTokutoku){
    const oy = window.PRICE_DB.getDiscount ? window.PRICE_DB.getDiscount(carrier, "oyako") : null;
    if (oyakoOn && isTokutoku && oy){
      oyako_now = Number(oy.year1 ?? oy.amount ?? 0) || 0;
      oyako_after = (dataUsage === "lte5")
        ? (Number(oy.after_le5 ?? 0) || 0)
        : (Number(oy.after_other ?? 0) || 0);
    }
  }

  let support39 = 0;
  if (getConsult(consult, side, "discSupport39", false) &&
      window.PRICE_DB.isDiscountEligible &&
      window.PRICE_DB.isDiscountEligible(carrier, "support39", planKey)){
    const d = window.PRICE_DB.getDiscount ? window.PRICE_DB.getDiscount(carrier, "support39") : null;
    support39 = d ? d.amount : 0;
  }

  let aupay = 0;
  if (getConsult(consult, side, "discAupay", false) &&
      window.PRICE_DB.isDiscountEligible && window.PRICE_DB.isDiscountEligible(carrier, "aupay", planKey)){
    const d = window.PRICE_DB.getDiscount ? window.PRICE_DB.getDiscount(carrier, "aupay") : null;
    aupay = d ? d.amount : 0;
  }

  let dcard = 0;
  if (carrier === "docomo" && !!getConsult(consult, side, "discDcard", false)){
    const kind = getConsult(consult, side, "dcardKind", "silver"); // silver|gold
    const key = (kind === "gold") ? "dcard_gold" : "dcard_silver";
    const d = window.PRICE_DB.getDiscount ? window.PRICE_DB.getDiscount("docomo", key) : null;
    dcard = d ? d.amount : 0;
  }

  let denki = 0;
  if (carrier === "docomo" &&
      getConsult(consult, side, "discDenki", false) &&
      window.PRICE_DB.isDiscountEligible &&
      window.PRICE_DB.isDiscountEligible(carrier, "denki", planKey)){
    const d = window.PRICE_DB.getDiscount ? window.PRICE_DB.getDiscount("docomo", "denki") : null;
    denki = d ? d.amount : 0;
  }

  // ===== mail carry =====
  const mailOn = !!getConsult(consult, side, "optMailCarry", false);
  const mail = mailOn ? (window.PRICE_DB.getMailCarry ? (window.PRICE_DB.getMailCarry(carrier)?.price || 0) : 0) : 0;

  // ===== custom (±) =====
  const custom = Number(getConsult(consult, side, "customDiscountYen", 0) || 0) || 0;

  const total = base + talkYen + mail + family + hikari + aupay + oyako_now + support39 + dcard + denki + custom;

  // ===== breakdown lines =====
  const lines = [];
  lines.push({ k:"プラン", v: base });

  if (talkEnabled){
    // 0円でも内包を明示したいなら表示（好みで）
    if (talkKind === "short" && includesCallShort){
      const m = includesMinutes ? `${includesMinutes}分` : "短時間";
      lines.push({ k:`短時間かけ放題（内包${m}）`, v: 0 });
    } else if (talkYen !== 0){
      const name =
        talkKind === "short" ? "短時間以内" :
        talkKind === "unlimited" ? "かけ放題" :
        talkKind === "min60" ? "1ヶ月60分" :
        talkKind === "senior" ? "60歳以上 24時間" : "通話OP";
      lines.push({ k:name, v: talkYen });
    }
  }

  if (mail !== 0)     lines.push({ k:"メール", v: mail });
  if (aupay !== 0)    lines.push({ k:"auPAYカード割", v: aupay });
  if (dcard !== 0){
    const kind = getConsult(consult, side, "dcardKind", "silver") === "gold" ? "ゴールド" : "シルバー";
    lines.push({ k:`dカード割（${kind}）`, v: dcard });
  }
  if (hikari !== 0)   lines.push({ k:"光割", v: hikari });
  if (family !== 0){
    const fc = Number(getConsult(consult, side, "discFamilyCount", 2) || 2) || 2;
    const tag = (fc >= 3) ? "3回線以上" : "2回線";
    lines.push({ k:`家族割（${tag}）`, v: family });
  }
  if (oyako_now !== 0) lines.push({ k:"親子割(1年間)", v: oyako_now });
  if (support39 !== 0) lines.push({ k:"39割", v: support39 });
  if (denki !== 0) lines.push({ k:"でんき割", v: denki });
  if (custom !== 0)   lines.push({ k:"任意調整", v: custom });

  return { total, totalAfter: (oyako_after ? (total - oyako_now + oyako_after) : null), lines, planKey };
}

function renderAll(){
  let { form, consult } = loadCtx();
  const mode = readMode();
  el("carrierGrid")?.classList.toggle("compare", mode === "compare");
  document.body.dataset.mode = mode;

  el("carrierBBlock")?.classList.toggle("hidden", mode !== "compare");
  el("optBlockB")?.classList.toggle("hidden", mode !== "compare");
  el("resultB")?.classList.toggle("hidden", mode !== "compare");
  el("deltaBox")?.classList.toggle("hidden", mode !== "compare");

  if (el("carrierA")) el("carrierA").value = consult.carrierA || "";
  if (el("carrierB")) el("carrierB").value = consult.carrierB || "";

  const a = el("carrierA")?.value || "";
  const b = el("carrierB")?.value || "";

  el("optTitleA") && (el("optTitleA").textContent = carrierLabel(a));
  el("optTitleB") && (el("optTitleB").textContent = carrierLabel(b));

  // プラン選択同期（planKeyを書き戻す）
  syncPlanSelect("A", a, form, consult);
  syncPlanSelect("B", b, form, consult);

  // planKeyがsyncで変わった可能性があるので読み直す
  ({ form, consult } = loadCtx());

  // 初期値だけ enforce（固定はしない）
  enforceDefaultsAfterPlan("A", a, consult);
  enforceDefaultsAfterPlan("B", b, consult);

  ({ form, consult } = loadCtx());

  // UQ割引の併用不可整合（光割優先）
  enforceUqDiscountRule("A", a, consult);
  enforceUqDiscountRule("B", b, consult);
  ({ form, consult } = loadCtx());

  // 割引可否UI（UQコミコミは割引自体を隠す）
  applyDiscountEligibilityUI("A", a, consult);
  applyDiscountEligibilityUI("B", b, consult);

  applyFamilyCountUI("A", a, consult);
  applyFamilyCountUI("B", b, consult);

  const aPlanKey = getConsult(consult, "A", "planKey", "");
  const bPlanKey = getConsult(consult, "B", "planKey", "");

  // ===== 「短時間」ラベル（内包分数があれば優先） =====
  const setShortKindLabel = (side, carrier, planKey) => {
    const btn = el(side + "_kind_short");
    if (!btn) return;

    const plan = window.PRICE_DB?.getPlan ? window.PRICE_DB.getPlan(carrier, planKey) : null;
    const includes = !!plan?.includes?.callShort;
    const mins = Number(plan?.includes?.callShortMinutes || 0) || 0;

    if (includes && mins){
      btn.textContent = `${mins}分以内`;
      return;
    }
    if (carrier === "docomo" || carrier === "ahamo" || carrier === "au" || carrier === "softbank"){
      btn.textContent = "5分以内";
    } else {
      btn.textContent = "10分以内";
    }
  };
  setShortKindLabel("A", a, aPlanKey);
  setShortKindLabel("B", b, bPlanKey);

  // ===== 種類表示：定義がないものは隠す =====
  const hasVoice = (carrier, kind) =>
    !!(window.PRICE_DB && window.PRICE_DB.getVoice && window.PRICE_DB.getVoice(carrier, kind));

  const applyTalkKindVisibility = (side, carrier, planKey) => {
    const komi = (carrier === "uq" && planKey === "komikomi_value");

    el(side + "_kind_unlimited")?.classList.toggle("hidden", !hasVoice(carrier, "unlimited"));

    el(side + "_kind_min60")?.classList.toggle(
      "hidden",
      komi || !hasVoice(carrier, "min60")
    );

    el(side + "_kind_senior")?.classList.toggle(
      "hidden",
      komi || !hasVoice(carrier, "senior")
    );
  };
  applyTalkKindVisibility("A", a, aPlanKey);
  applyTalkKindVisibility("B", b, bPlanKey);

  // ===== 通話UI状態反映（enabled + kind） =====
  const applyTalkState = (side, carrier, consult) => {
  const komi = isUqKomikomi(carrier, consult, side);

  // コミコミは必ず通話ON
  if (komi){
    const enabled = !!getConsult(consult, side, "talkEnabled", false);
    const kind = getConsult(consult, side, "talkKind", "short");
    if (!enabled || kind !== "short"){
      forceKomikomiTalkOn(side);
      // localStorage更新されるので、この呼び出し元(renderAll)側で後でloadCtxし直すのが理想
    }
    if (kind === "min60" || kind === "senior"){
      forceKomikomiTalkOn(side); // => talkEnabled:true, talkKind:"short"
    }
  }

  if (isAhamo(carrier)){
    const enabled = !!getConsult(consult, side, "talkEnabled", false);
    const kind = getConsult(consult, side, "talkKind", "short");
    if (!enabled || kind !== "short"){
      forceAhamoTalkOn(side);
    }
  }

  const enabled = !!getConsult(consult, side, "talkEnabled", false);
  const kind = getConsult(consult, side, "talkKind", "short");

  // コミコミは OFFボタン自体を消す（視覚的にも「なし不可」）
  el(side + "_talk_off")?.classList.toggle("hidden", komi);

  // kinds row show/hide（コミコミは常に表示）
  el(side + "_talkKinds")?.classList.toggle("hidden", !enabled && !komi);

  const sw = el(side + "_talkSwitch");
  if (sw){
    const komi = isUqKomikomi(carrier, consult, side);
    const enabled = !!getConsult(consult, side, "talkEnabled", false) || komi;
    sw.setAttribute("aria-pressed", enabled ? "true" : "false");
  }
  el(side + "_talkKinds")?.classList.toggle("hidden", !(!!getConsult(consult, side, "talkEnabled", false)) && !isUqKomikomi(carrier, consult, side));

  // kinds
  pillSet(el(side + "_kind_short"),     (enabled || komi) && kind === "short");
  pillSet(el(side + "_kind_unlimited"), (enabled || komi) && kind === "unlimited");
  pillSet(el(side + "_kind_min60"),     (enabled || komi) && kind === "min60");
  pillSet(el(side + "_kind_senior"),    (enabled || komi) && kind === "senior");
};
  applyTalkState("A", a, consult);
  applyTalkState("B", b, consult);

  // ===== その他pill状態 =====
  pillSet(el("A_mail"),   !!getConsult(consult,"A","optMailCarry",false));
  pillSet(el("A_family"), !!getConsult(consult,"A","discFamily",false));
  pillSet(el("A_hikari"), !!getConsult(consult,"A","discHikari",false));
  pillSet(el("A_oyako"),  !!getConsult(consult,"A","discOyako",false));
  pillSet(el("A_support39"), !!getConsult(consult,"A","discSupport39",false));
  pillSet(el("A_aupay"),  !!getConsult(consult,"A","discAupay",false));
  pillSet(el("A_denki"), !!getConsult(consult,"A","discDenki",false));


  pillSet(el("B_mail"),   !!getConsult(consult,"B","optMailCarry",false));
  pillSet(el("B_family"), !!getConsult(consult,"B","discFamily",false));
  pillSet(el("B_hikari"), !!getConsult(consult,"B","discHikari",false));
  pillSet(el("B_oyako"),  !!getConsult(consult,"B","discOyako",false));
  pillSet(el("B_support39"), !!getConsult(consult,"B","discSupport39",false));
  pillSet(el("B_aupay"),  !!getConsult(consult,"B","discAupay",false));
  pillSet(el("B_denki"), !!getConsult(consult,"B","discDenki",false));

  // 任意調整欄の同期
  if (el("A_customDiscountYen")) el("A_customDiscountYen").value = String(Number(getConsult(consult,"A","customDiscountYen",0) || 0) || 0);
  if (el("A_customDiscountNote")) el("A_customDiscountNote").value = getConsult(consult,"A","customDiscountNote","") || "";
  if (el("B_customDiscountYen")) el("B_customDiscountYen").value = String(Number(getConsult(consult,"B","customDiscountYen",0) || 0) || 0);
  if (el("B_customDiscountNote")) el("B_customDiscountNote").value = getConsult(consult,"B","customDiscountNote","") || "";

  updateCustomBadge("A", consult);
  updateCustomBadge("B", consult);

  applyDcardUI("A", a, consult);
  applyDcardUI("B", b, consult);

  // ===== 結果 =====
  el("brandA") && (el("brandA").textContent = carrierLabel(a));
  el("brandB") && (el("brandB").textContent = carrierLabel(b));

  const rA = calcMonthly(a, form, consult, "A");
  if (Number.isFinite(rA.totalAfter)){
    rA.lines = [...(rA.lines||[]), { k:"1年後目安", v: rA.totalAfter }];
  }
  el("priceA").textContent = yen(rA.total);
  renderBreakdown("bdA", rA.lines || []);
  const rB = calcMonthly(b, form, consult, "B");

  el("priceA") && (el("priceA").textContent = yen(rA.total));
  renderBreakdown("bdA", rA.lines || []);
  el("priceB") && (el("priceB").textContent = yen(rB.total));
  renderBreakdown("bdB", rB.lines || []);

  if (mode === "compare" && a && b && Number.isFinite(rA.total) && Number.isFinite(rB.total)){
    const d = rA.total - rB.total;
    el("deltaText") && (el("deltaText").textContent = `差額：${yen(Math.abs(d))}`);
  } else {
    el("deltaText") && (el("deltaText").textContent = "差額：—");
  }

  renderCarrierCards("A");
  if (readMode() === "compare") renderCarrierCards("B");
}

  function bind(){
    const toggleMode = () => {
      const mode = readMode();
      setMode(mode === "single" ? "compare" : "single");
      renderAll();
    };
    click("modeToggle", toggleMode);
    on("modeToggle","keydown",(e)=>{
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggleMode(); }
    });

    on("carrierA", "change", ()=>{
      saveConsultPatch({ carrierA: el("carrierA")?.value || "" });
      const next = el("carrierA")?.value || "";
      setConsultPatch("A", {
        planKey: "",
        discFamily:false, discHikari:false, discOyako:false, discAupay:false,
        talkEnabled: (next === "ahamo") ? true : false,
        talkKind:"short",
      });
      renderAll();
    });
    on("carrierB", "change", ()=>{
      saveConsultPatch({ carrierB: el("carrierB")?.value || "" });
      const next = el("carrierB")?.value || "";
      setConsultPatch("B", {
        planKey: "",
        discFamily:false, discHikari:false, discOyako:false, discAupay:false,
        talkEnabled: (next === "ahamo") ? true : false,
        talkKind:"short",
      });
      renderAll();
    });

    on("A_planSelect", "change", ()=>{
      setConsultPatch("A", { planKey: el("A_planSelect")?.value || "" });
      renderAll();
    });
    on("B_planSelect", "change", ()=>{
      setConsultPatch("B", { planKey: el("B_planSelect")?.value || "" });
      renderAll();
    });

    on("A_familyCount", "change", ()=>{
      const v = (el("A_familyCount")?.value === "3") ? 3 : 2;
      setConsultPatch("A", { discFamilyCount: v });
      renderAll();
    });
    on("B_familyCount", "change", ()=>{
      const v = (el("B_familyCount")?.value === "3") ? 3 : 2;
      setConsultPatch("B", { discFamilyCount: v });
      renderAll();
    });

    const setTalkEnabled = (side, on) => { setConsultPatch(side, { talkEnabled: !!on }); renderAll(); };
      const setTalkKind = (side, kind) => {
      const { consult } = loadCtx();
      const carrier = (side === "A")
        ? (el("carrierA")?.value || consult.carrierA || "")
        : (el("carrierB")?.value || consult.carrierB || "");

      // UQコミコミは min60 / senior 選択不可
      if (carrier === "uq"){
        const planKey = getConsult(consult, side, "planKey", "");
        const komi = (planKey === "komikomi_value");
        if (komi && (kind === "min60" || kind === "senior")){
          // 何もしない（または short に寄せるなら forceKomikomiTalkOn(side);）
          return;
        }
      }

      setConsultPatch(side, { talkEnabled:true, talkKind: kind });
      renderAll();
    };

    click("A_talkSwitch", () => {
      const { consult } = loadCtx();
      const carrier = el("carrierA")?.value || consult.carrierA || "";
      const enabled = !!getConsult(consult,"A","talkEnabled",false);

      // コミコミはOFF禁止：押してもON維持
      if (isUqKomikomi(carrier, consult, "A")){
        forceKomikomiTalkOn("A");
      } else {
        setConsultPatch("A", { talkEnabled: !enabled });
      }
      renderAll();
    });
    click("A_kind_short",     () => setTalkKind("A","short"));
    click("A_kind_unlimited", () => setTalkKind("A","unlimited"));
    click("A_kind_min60",     () => setTalkKind("A","min60"));
    click("A_kind_senior",    () => setTalkKind("A","senior"));

    click("B_talkSwitch", () => {
      const { consult } = loadCtx();
      const carrier = el("carrierB")?.value || consult.carrierB || "";
      const enabled = !!getConsult(consult,"B","talkEnabled",false);

      if (isUqKomikomi(carrier, consult, "B")){
        forceKomikomiTalkOn("B");
      } else {
        setConsultPatch("B", { talkEnabled: !enabled });
      }
      renderAll();
    });
    click("B_kind_short",     () => setTalkKind("B","short"));
    click("B_kind_unlimited", () => setTalkKind("B","unlimited"));
    click("B_kind_min60",     () => setTalkKind("B","min60"));
    click("B_kind_senior",    () => setTalkKind("B","senior"));

    click("A_mail", () => {
      const { consult } = loadCtx();
      setConsultPatch("A", { optMailCarry: !getConsult(consult,"A","optMailCarry",false) });
      renderAll();
    });
    click("B_mail", () => {
      const { consult } = loadCtx();
      setConsultPatch("B", { optMailCarry: !getConsult(consult,"B","optMailCarry",false) });
      renderAll();
    });

    // discounts（UQは光割優先ルール＋auPAY追加）
    click("A_family", () => {
      const { consult } = loadCtx();
      const carrier = el("carrierA")?.value || consult.carrierA || "";
      toggleDiscountWithUqRule("A", carrier, "family");
      renderAll();
    });
    click("A_hikari", () => {
      const { consult } = loadCtx();
      const carrier = el("carrierA")?.value || consult.carrierA || "";
      toggleDiscountWithUqRule("A", carrier, "hikari");
      renderAll();
    });

    click("A_oyako", () => {
      const { consult } = loadCtx();
      const carrier = el("carrierA")?.value || consult.carrierA || "";
      const planKey = getConsult(consult, "A", "planKey", "");
      const cur = !!getConsult(consult, "A", "discOyako", false);

      // UQ + 対象プランのみ
      const ok = window.PRICE_DB?.isDiscountEligible
      ? window.PRICE_DB.isDiscountEligible(carrier, "oyako", planKey)
      : false;
      if (!ok){
        // 対象外ならOFFに戻す（事故防止）
        if (cur) setConsultPatch("A", { discOyako:false });
        renderAll();
        return;
      }

      // 家族割と同時ONは事故りやすいのでOFFに寄せる（必要ならここ削る）
      const famOn = !!getConsult(consult, "A", "discFamily", false);
      setConsultPatch("A", { discOyako: !cur, discFamily: (!cur ? false : famOn) });

      renderAll();
    });

    click("A_support39", () => {
      const { consult } = loadCtx();
      const cur = !!getConsult(consult, "A", "discSupport39", false);
      setConsultPatch("A", { discSupport39: !cur });
      renderAll();
    });
    click("A_aupay", () => {
      const { consult } = loadCtx();
      const carrier = el("carrierA")?.value || consult.carrierA || "";
      toggleDiscountWithUqRule("A", carrier, "aupay");
      renderAll();
    });

    click("A_dcardPill", () => {
  const { consult } = loadCtx();
  const carrier = el("carrierA")?.value || consult.carrierA || "";
  if (carrier !== "docomo") return;

  const cur = !!getConsult(consult, "A", "discDcard", false);
  setConsultPatch("A", { discDcard: !cur });
  renderAll();
});

on("A_dcard", "change", () => {
  const v = el("A_dcard")?.value === "gold" ? "gold" : "silver";
  setConsultPatch("A", { dcardKind: v, discDcard: true });
  renderAll();
});

click("B_dcardPill", () => {
  const { consult } = loadCtx();
  const carrier = el("carrierB")?.value || consult.carrierB || "";
  if (carrier !== "docomo") return;

  const cur = !!getConsult(consult, "B", "discDcard", false);
  setConsultPatch("B", { discDcard: !cur });
  renderAll();
});

on("B_dcard", "change", () => {
  const v = el("B_dcard")?.value === "gold" ? "gold" : "silver";
  setConsultPatch("B", { dcardKind: v, discDcard: true });
  renderAll();
});

click("A_denki", () => {
  const { consult } = loadCtx();
  const carrier = el("carrierA")?.value || consult.carrierA || "";
  if (carrier !== "docomo") return; // ★事故防止
  const cur = !!getConsult(consult, "A", "discDenki", false);
  setConsultPatch("A", { discDenki: !cur });
  renderAll();
});

click("B_denki", () => {
  const { consult } = loadCtx();
  const carrier = el("carrierB")?.value || consult.carrierB || "";
  if (carrier !== "docomo") return; // ★事故防止
  const cur = !!getConsult(consult, "B", "discDenki", false);
  setConsultPatch("B", { discDenki: !cur });
  renderAll();
});

    click("B_family", () => {
      const { consult } = loadCtx();
      const carrier = el("carrierB")?.value || consult.carrierB || "";
      toggleDiscountWithUqRule("B", carrier, "family");
      renderAll();
    });
    click("B_hikari", () => {
      const { consult } = loadCtx();
      const carrier = el("carrierB")?.value || consult.carrierB || "";
      toggleDiscountWithUqRule("B", carrier, "hikari");
      renderAll();
    });
    click("B_oyako", () => {
      const { consult } = loadCtx();
      const carrier = el("carrierB")?.value || consult.carrierB || "";
      const planKey = getConsult(consult, "B", "planKey", "");
      const cur = !!getConsult(consult, "B", "discOyako", false);

      const ok = window.PRICE_DB?.isDiscountEligible
      ? window.PRICE_DB.isDiscountEligible(carrier, "oyako", planKey)
      : false;
      if (!ok){
        if (cur) setConsultPatch("B", { discOyako:false });
        renderAll();
        return;
      }

      const famOn = !!getConsult(consult, "B", "discFamily", false);
      setConsultPatch("B", { discOyako: !cur, discFamily: (!cur ? false : famOn) });

      renderAll();
    });

    click("B_support39", () => {
      const { consult } = loadCtx();
      const cur = !!getConsult(consult, "B", "discSupport39", false);
      setConsultPatch("B", { discSupport39: !cur });
      renderAll();
    });
    click("B_aupay", () => {
      const { consult } = loadCtx();
      const carrier = el("carrierB")?.value || consult.carrierB || "";
      toggleDiscountWithUqRule("B", carrier, "aupay");
      renderAll();
    });

    on("A_customDiscountYen", "change", ()=>{
      let v = Number(el("A_customDiscountYen")?.value || 0) || 0;
      if (el("A_customDiscountYen")) el("A_customDiscountYen").value = String(v);
      setConsultPatch("A", { customDiscountYen: v });
      renderAll();
    });
    on("A_customDiscountNote", "change", ()=>{
      setConsultPatch("A", { customDiscountNote: el("A_customDiscountNote")?.value || "" });
      renderAll();
    });

    on("B_customDiscountYen", "change", ()=>{
      let v = Number(el("B_customDiscountYen")?.value || 0) || 0;
      if (el("B_customDiscountYen")) el("B_customDiscountYen").value = String(v);
      setConsultPatch("B", { customDiscountYen: v });
      renderAll();
    });
    on("B_customDiscountNote", "change", ()=>{
      setConsultPatch("B", { customDiscountNote: el("B_customDiscountNote")?.value || "" });
      renderAll();
    });
    click("backToContractBtn", () => {
      window.location.href = "ContractNavigator.html";
    });
  }

  function init(){
    const { consult } = loadCtx();

    if (!consult.viewMode) saveConsultPatch({ viewMode:"single" });

    if (el("payType")) el("payType").value = consult.payType || "";
    if (el("needDataTransfer")) el("needDataTransfer").value = consult.needDataTransfer || "no";
    if (el("needTradeInReception")) el("needTradeInReception").value = consult.needTradeInReception || "no";

    // talk default
    if (!("A_talkEnabled" in consult)) setConsultPatch("A", { talkEnabled:false, talkKind:"short" });
    if (!("B_talkEnabled" in consult)) setConsultPatch("B", { talkEnabled:false, talkKind:"short" });

    // ahamoは初期5分
    const a0 = consult.carrierA || "";
    const b0 = consult.carrierB || "";
    if (a0 === "ahamo") setConsultPatch("A", { talkEnabled:true, talkKind:"short" });
    if (b0 === "ahamo") setConsultPatch("B", { talkEnabled:true, talkKind:"short" });

    bind();
    renderAll();
  }

  init();
  </script>
  <nav class="appSwitch" aria-label="アプリ切替">
  <a href="ContractNavigator.html" title="契約ナビ">📋</a>
  <a href="CarrierPalette.html" class="on" title="キャリアパレット">📱</a>
  <a href="BBNavigator.html" title="BBナビ">🏠</a>
</nav>
</body>
</html>