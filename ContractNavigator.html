<!-- =========================
     ContractNavigator.html
     ========================= -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¥‘ç´„ãƒŠãƒ“</title>
    <link rel="apple-touch-icon" sizes="180x180" href="./Icon.png">
  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
      margin:0;
      color:#111;
      font-size:17px;
      background: transparent;
    }

    html::before{
      content:"";
      position:fixed;
      inset:0;
      z-index:-1;
      pointer-events:none;

      background:
        linear-gradient(rgba(246,247,249,0.60), rgba(246,247,249,0.60)),
        url("img/consaru.png") center/150% repeat,
        #f6f7f9;
    }
    :root{
      --header-h: 200px;
    }

    html, body{
      height:100%;
      overflow:hidden;      /* ãƒšãƒ¼ã‚¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®å›ºå®š */
    }

    .wrap{
    height: calc(100vh - var(--header-h));
    overflow:auto;
    -webkit-overflow-scrolling: touch;

    max-width:960px;
    margin:0 auto;
    padding:12px 16px 40px;
    }

.appHeaderCard{
  position:relative;
}

.appHeaderRow{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}

.appTitle{
  font-size:22px;
  margin:0;
  font-weight:1100;
}

.appSub{
  font-size:12px;
  color:#555;
  font-weight:900;
  margin-top:2px;
}

/* ä¸­å¤®ã‚„ã‚„å³ãƒ»å¤§ãã‚ */
.devBadge{
  position:absolute;
  top:50%;
  left:35%;
  transform:translate(-50%, -50%);

  font-size:15px;
  font-weight:1100;
  letter-spacing:.12em;

  color:#fff;
  background:#d40000;

  padding:7px 16px;
  border-radius:999px;
  opacity: 0.8;

  pointer-events:none;
}

    .donebox{
      background:#f6fbff;
      border:1px solid #d6e8ff;
      border-radius:12px;
      padding:12px;
      margin-top:10px;
    }

    .donebox b{
      display:inline-block;
      margin-bottom:6px;
    }

    header{
      padding:16px 16px 8px;
      background:#fff;
      border-bottom:1px solid #e6e8eb;
      position:relative;
      top:0;
      z-index:10;
    }

    .helpBtn{
      position:absolute;
      top:26px;
      right:24px;

      width:26px;
      height:26px;
      border-radius:50%;

      border:1px solid #7f848a;
      background:#ffffff;
      color:#5e666e;

      font-size:15px;
      font-weight:900;
      line-height:1;
      cursor:pointer;

      box-shadow:0 1px 3px rgba(0,0,0,.15);
    }

    .helpBtn:active{
      transform:scale(0.96);
    }

    .carrierRow{
  display:flex;
  gap:10px;
  flex-wrap:nowrap;
}

.carrierSel{
  flex: 1 1 65%;
}

.upgradeSel{
  flex: 1 1 35%;
}

    .btnDanger{
      border:1px solid #ffd2d2;
      background:#fff5f5;
      color:#b00020;
      border-radius:12px;
      padding:14px 16px;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
    }
    .resetGroup button{
      opacity:0.85;
    }
    .resetGroup button:hover{
      opacity:1;
    }
    .title{font-size:24px;font-weight:800;}
    .sub{font-size:15px;color:#555;margin-top:4px;}
    .card{
      background:#fff;border:1px solid #e6e8eb;border-radius:14px;padding:14px;
      box-shadow:0 1px 2px rgba(0,0,0,.04);margin-top:12px;
    }
    .legal{color:#b00020;font-weight:800;}
    .state{font-size:20px;font-weight:800;}
    .muted{color:#555;font-size:14px;line-height:1.5;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .btn{border:0;background:#111;color:#fff;border-radius:12px;padding:14px 16px;font-size:16px;cursor:pointer;}
    .btn:disabled{opacity:.4;cursor:not-allowed;}
    .btn2{border:1px solid #d9dde3;background:#fff;color:#111;border-radius:12px;padding:14px 16px;font-size:16px;cursor:pointer;}
    .stepbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .step{padding:10px 14px;border-radius:12px;background:#f0f2f5;font-size:16px;cursor:pointer;user-select:none;}
    .step.current{background:#dfe8ff;border:1px solid #9db6ff;}
    .step.done{background:#e7f7ea;border:1px solid #9fe0aa;}
    .warn{background:#fff5f5;border:1px solid #ffd2d2;border-radius:12px;padding:12px;margin-top:10px;font-size:15px;}
    .warn b,.next b{display:inline-block;margin-bottom:6px;}
    .next{background:#f7f7ff;border:1px solid #d8ddff;border-radius:12px;padding:12px;margin-top:10px;}
    .hidden{display:none !important;}
    label{font-size:16px;color:#333;}
    select{
      width:100%;padding:14px 12px;border-radius:10px;border:1px solid #d9dde3;
      font-size:17px;background:#fff;
    }
    .hiddenRow{ display:none !important; }
    .grid{
        display:grid;
        gap:10px;
        margin-top:10px;

        grid-template-columns: 1fr 1fr;
      }

      @media (max-width: 360px){
        .grid{ grid-template-columns: 1fr; }
      }
    .divider{height:1px;background:#eef0f3;margin:12px 0;}
    .badge{
      display:inline-block;font-size:17px;padding:8px 16px;border-radius:999px;
      background:#f0f2f5;border:1px solid #e0e4ea;color:#333;
    }
    .badge.done{
      background:#e7f7ea;
      border:1px solid #9fe0aa;
      color:#1b5e20;
      font-weight:800;
    }
    .finishWrap{
      position: relative;
      max-width: 300px;
      margin: 0 auto;
      padding: 14px;
      background: #67abec;
      border-radius: 14px;
      border: 1px solid #67abec;
    }
    .finishWrap img{
      width: 100%;
      height: auto;
      display: block;
      border-radius: 12px;
    }
    .finishText{
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #ffffff;
      font-size: 40px;
      font-weight: 900;
      letter-spacing: 0.08em;
      text-shadow:
        0 2px 6px rgba(0,0,0,0.35),
        0 0 10px rgba(0,0,0,0.25);
      pointer-events: none;
    }

    select{
  transition: box-shadow 160ms ease, border-color 160ms ease, transform 120ms ease;
}

select.isSelected{
  border-color:#9db6ff;
  box-shadow: 0 0 0 4px rgba(157,182,255,.35);
}

@keyframes pop{
  0%{ transform:scale(1); }
  40%{ transform:scale(1.015); }
  100%{ transform:scale(1); }
}

select.pop{
  animation: pop 180ms ease;
}
    .checklist{margin-top:10px;display:flex;flex-direction:column;gap:8px;}
    .checkitem{
      display:flex;gap:10px;align-items:flex-start;
      border:1px solid #e6e8eb;border-radius:12px;padding:10px 12px;background:#fff;
    }
    .checkitem input{margin-top:2px;transform:scale(1.2);}
    .checkitem .ctitle{font-size:15px;font-weight:700;}
    .checkitem .csub{font-size:14px;color:#555;margin-top:2px;line-height:1.35;}
    .alert{
      background:#fff5f5;border:1px solid #ffd2d2;border-radius:12px;padding:10px 12px;margin-top:10px;
      color:#b00020;font-size:15px;font-weight:700;
    }
    .red{color:#b00020;font-size:15px;font-weight:800;}

    #navRow button{min-height:48px;}
    #summaryText { display:none !important; }
    #linebarMini .step{
      border-radius:999px;
      font-weight:700;
      padding:8px 14px;
    }
    #linebar .step,
    #linebarMini .step{
      border-radius:999px;
      font-weight:700;
      padding:8px 14px;
    }

    /* ===== å›ç·š1ï¼šç´« ===== */
    #linebar .step:nth-child(1),
    #linebarMini .step:nth-child(1){
      background:#f3f1fb;
      border:1px solid #d9d3f2;
      color:#4a3f7a;
    }
    #linebar .step:nth-child(1).current,
    #linebarMini .step:nth-child(1).current{
      background:#e6defa;
      border:2px solid #7a5ce6;
      color:#2f1c6b;
    }

    /* ===== å›ç·š2ï¼šã‚ªãƒ¬ãƒ³ã‚¸ ===== */
    #linebar .step:nth-child(2),
    #linebarMini .step:nth-child(2){
      background:#fff3e6;
      border:1px solid #ffd7b5;
      color:#8a4b00;
    }
    #linebar .step:nth-child(2).current,
    #linebarMini .step:nth-child(2).current{
      background:#ffe1c2;
      border:2px solid #ff9800;
      color:#5a2f00;
    }

    /* ===== å›ç·š3ï¼šãƒ”ãƒ³ã‚¯ ===== */
    #linebar .step:nth-child(3),
    #linebarMini .step:nth-child(3){
      background:#fff0f6;
      border:1px solid #f5c2d8;
      color:#7a294e;
    }
    #linebar .step:nth-child(3).current,
    #linebarMini .step:nth-child(3).current{
      background:#ffd6e8;
      border:2px solid #e91e63;
      color:#4a102b;
    }

    /* ===== å›ç·š4ï¼šãƒ–ãƒ©ã‚¦ãƒ³ ===== */
    #linebar .step:nth-child(4),
    #linebarMini .step:nth-child(4){
      background:#f6efe9;
      border:1px solid #d8c7b7;
      color:#5c3b1e;
    }
    #linebar .step:nth-child(4).current,
    #linebarMini .step:nth-child(4).current{
      background:#eadfd5;
      border:2px solid #8d6e63;
      color:#3e2614;
    }

    /* ===== å›ç·š5ï¼šãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼ ===== */
    #linebar .step:nth-child(5),
    #linebarMini .step:nth-child(5){
      background:#f1f1f1;
      border:1px solid #cfcfcf;
      color:#333;
    }
    #linebar .step:nth-child(5).current,
    #linebarMini .step:nth-child(5).current{
      background:#e0e0e0;
      border:2px solid #555;
      color:#111;
    }

    /* ===== ç¾åœ¨é¸æŠå›ç·šã®å¼·èª¿ ===== */
    #linebar .step.current::before,
    #linebarMini .step.current::before{
      content:"â–¶";
      margin-right:6px;
    }

.appSwitch{
  position:fixed;
  right:18px;
  bottom:18px;
  display:flex;
  gap:14px;
  z-index:9999;
}

.appSwitch a{
  width:64px;
  height:64px;
  display:grid;
  place-items:center;
  border-radius:22px;
  border:1px solid #d9dde3;
  background:#fff;
  text-decoration:none;
  box-shadow: 0 10px 26px rgba(0,0,0,0.18);
  font-size:30px;   /* â† ã‚¢ã‚¤ã‚³ãƒ³å¤§ãã */
  user-select:none;
  -webkit-tap-highlight-color: transparent;
  transition: all 120ms ease;
}

.appSwitch a.on{
  border-color:#111;
  box-shadow: 0 12px 30px rgba(0,0,0,0.22);
}

.appSwitch a:active{
  transform: translateY(2px) scale(0.97);
}
  </style>
  <script src="data.js"></script>
</head>
<body>
<header>
  <div class="title">å¥‘ç´„ãƒŠãƒ“</div>
  <div class="sub">ãƒ’ã‚¢ãƒªãƒ³ã‚°ãƒ»å¥‘ç´„ãƒ•ãƒ­ãƒ¼ç¢ºèª</div>
  <button id="helpBtn" class="helpBtn">i</button>
  <div class="devBadge">âš  é–‹ç™ºä¸­ âš </div>
</header>

<div class="wrap">
  <div class="card" style="margin-top:12px;">
  <div class="state">ğŸ“±å›ç·š</div>
  <div class="row" style="gap:8px; align-items:center;">
    <div class="stepbar" id="linebar" style="margin-top:0;"></div>
    <button class="btn2" id="addLineBtn">ï¼‹å›ç·šè¿½åŠ </button>
    <button class="btn2" id="removeLineBtn">ï¼å‰Šé™¤</button>
  </div>
</div>

<div class="card">
  <div class="state">ğŸ“‹ãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚·ãƒ¼ãƒˆ</div>

  <div class="divider"></div>
  <div class="row" style="gap:8px;">
    <span class="badge" id="badge_basic">åŸºæœ¬é …ç›®</span>
  </div>

  <div class="grid">
    <div>
      <label>å¥‘ç´„ã‚¿ã‚¤ãƒ—</label>
      <select id="contractType">
        <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="mnpDevice">MNPï¼ˆç«¯æœ«ã‚ã‚Šï¼‰</option>
        <option value="mnpSim">MNPï¼ˆSIMã®ã¿ï¼‰</option>
        <option value="deviceChange">æ©Ÿç¨®å¤‰æ›´</option>
        <option value="new">ç´”æ–°è¦</option>
      </select>
    </div>

    <div>
      <label>å¥‘ç´„è€…æ§˜ï¼ˆåç¾©ï¼‰</label>
      <select id="contractHolder">
        <option value="self" selected>ã”æœ¬äºº</option>
        <option value="spouse">é…å¶è€…</option>
        <option value="child">ãŠå­æ§˜</option>
        <option value="parent">ã”ä¸¡è¦ª</option>
        <option value="other">ãã®ä»–</option>
      </select>
    </div>

    <div>
      <label>ç¾åœ¨ãŠä½¿ã„ã®ã‚­ãƒ£ãƒªã‚¢</label>
      <div class="carrierRow">
        <select id="carrier" class="carrierSel">
          <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="docomo">docomo</option>
          <option value="ahamo">ahamo</option>
          <option value="au">au</option>
          <option value="uq">UQ mobile</option>
          <option value="softbank">SoftBank</option>
          <option value="ymobile">Y!mobile</option>
          <option value="other">ãã®ä»–</option>
        </select>
      </div>
    </div>

    <div>
      <label>ã”åˆ©ç”¨è€…æ§˜</label>
      <select id="userRelation">
        <option value="self" selected>ã”æœ¬äºº</option>
        <option value="spouse">é…å¶è€…</option>
        <option value="child">ãŠå­æ§˜</option>
        <option value="parent">ã”ä¸¡è¦ª</option>
        <option value="other">ãã®ä»–</option>
      </select>
    </div>

    <div>
      <label>æœˆã®ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨é‡ï¼ˆç›®å®‰ï¼‰</label>
      <select id="dataUsage">
        <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="lte5">ã€œ5GB</option>
        <option value="lte30">ã€œ30GB</option>
        <option value="unlimited">30GBä»¥ä¸Šï¼ˆç„¡åˆ¶é™ï¼‰</option>
      </select>
    </div>

    <div>
      <label>ã”è‡ªå®…ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå›ç·š</label>
      <select id="homeNetType">
        <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="fletshikari">ãƒ•ãƒ¬ãƒƒãƒ„å…‰</option>
        <option value="nurohikari">NUROå…‰</option>
        <option value="docomohikari">ãƒ‰ã‚³ãƒ¢å…‰</option>
        <option value="niftyhikari">@niftyå…‰</option>
        <option value="softbankhikari">ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯å…‰</option>
        <option value="auhikari">auã²ã‹ã‚Š</option>
        <option value="jcom">J:COM</option>
        <option value="home5g">ãƒ›ãƒ¼ãƒ ãƒ«ãƒ¼ã‚¿ãƒ¼</option>
        <option value="unknown">ãã®ä»–</option>
        <option value="included">ã‚«ãƒ³ã‚³ãƒŸï¼ˆç®¡ç†è²»è¾¼ã¿ï¼‰</option>
        <option value="none">ã”åˆ©ç”¨ãªã—</option>
      </select>
    </div>
  </div>

  <div class="divider"></div>
  <div class="row" style="gap:8px;"> <span class="badge" id="badge_check">å¥‘ç´„å‰ãƒã‚§ãƒƒã‚¯</span> </div>
  <div class="checklist">
    <div class="checkitem">
      <input type="checkbox" id="chk_id_confirmed" />
      <div>
        <div class="ctitle">æœ¬äººç¢ºèªæ›¸é¡ã‚’ç¢ºèªã—ã¾ã—ãŸ</div>
        <div class="csub">é‹è»¢å…è¨±è¨¼ï¼ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰ï¼åœ¨ç•™ã‚«ãƒ¼ãƒ‰+å¤–å›½ç™ºè¡Œãƒ‘ã‚¹ãƒãƒ¼ãƒˆ</div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_homeNet_asked" />
      <div>
        <div class="ctitle">ã‚­ãƒ£ãƒªã‚¢ãŠã‚ˆã³å…‰å›ç·šã®åˆ©ç”¨å¹´æ•°ã‚’ç¢ºèªã—ã¾ã—ãŸ</div>
        <div class="csub">ã‚­ãƒ£ãƒªã‚¢ã¯åŠå¹´ï¼Œå…‰å›ç·šã¯1å¹´æœªæº€ã®å ´åˆï¼Œæ–½ç­–ãŒé©ç”¨ã§ããªã„å ´åˆã‚‚</div>
      </div>
    </div>
  </div>

  <!-- ç«¯æœ«ã‚ã‚Šã®ã¨ãã ã‘ï¼šä¸‹å–ã‚Šç¢ºèª -->
  <div class="checklist hidden" id="tradeinBlock">
    <div class="checkitem">
      <input type="checkbox" id="chk_tradein" />
      <div style="flex:1;">
        <div class="ctitle">ç«¯æœ«ä¸‹å–ã‚Šã®å¯å¦ã‚’ç¢ºèªã—ã¾ã—ãŸ</div>
        <div class="csub">åˆ†å‰²ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ã”åˆ©ç”¨ã®å ´åˆã€ç«¯æœ«ã®æ®‹å‚µã‚’ç¢ºèªã—ã¦ãã ã•ã„</div>
      </div>

      <select id="tradeinResult" style="width:140px; padding:10px 10px; border-radius:10px;">
        <option value="" selected>æœªé¸æŠ</option>
        <option value="ok">ä¸‹å–ã‚ŠOK</option>
        <option value="ng">ä¸‹å–ã‚ŠNG</option>
      </select>
    </div>
  </div>

  <div class="alert hidden" id="preAlert"></div>

  <div class="row" style="margin-top:12px; align-items:center; width:100%;">
    <div class="row" style="gap:10px;">
      <button class="btn" id="startBtn" disabled>ã“ã®æ¡ä»¶ã§é–‹å§‹</button>
    </div>
    <div style="flex:1;"></div>
    <div class="row resetGroup" style="gap:10px;">
      <button class="btn2" id="resetBtn">ã“ã®å›ç·šã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      <button class="btnDanger" id="wipeAllBtn">å…¨ã¦ã®å›ç·šã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>
</div>

  <!-- ã‚¹ãƒ†ãƒƒãƒ—å†…å®¹ -->
  <div class="card" id="stepCard">
    <div class="row" style="gap:8px; align-items:center; margin-top:8px;">
      <div class="stepbar" id="linebarMini" style="margin-top:0;"></div>
    </div>

    <div class="stepbar" id="stepbar"></div>
    <div class="muted" id="summaryText">æ¡ä»¶ã‚’é¸ã‚“ã§é–‹å§‹ã—ã¦ãã ã•ã„</div>

    <div class="divider"></div>
    <div class="state" id="stepTitle">é–‹å§‹ã—ã¦ãã ã•ã„</div>

    <div class="donebox hidden" id="s2Box">
  <div id="s2LineSummary" class="muted"></div>

  <b>ğŸ§¾ ç«¯æœ« / ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ / ä¸‹å–ã‚Š</b>
  <div class="grid" style="margin-top:10px;">
    <div id="s2ToCarrierWrap">
      <label>ä¹—ã‚Šæ›ãˆå…ˆ</label>
      <select id="s2ToCarrier">
        <option value="" selected>æœªé¸æŠ</option>
        <option value="docomo">docomo</option>
        <option value="ahamo">ahamo</option>
        <option value="au">au</option>
        <option value="uq">UQ mobile</option>
        <option value="softbank">SoftBank</option>
        <option value="ymobile">Y!mobile</option>
        <option value="other">ãã®ä»–</option>
      </select>
    </div>

    <div id="s2ToPlanWrap">
      <label>ä¹—ã‚Šæ›ãˆå…ˆãƒ—ãƒ©ãƒ³</label>
      <select id="s2ToPlanKey" disabled>
        <option value="" selected>æœªé¸æŠ</option>
      </select>
    </div>

    <div id="s2PayWrap">
      <label>ç«¯æœ«è³¼å…¥æ–¹æ³•</label>
      <select id="s2PayType">
        <option value="" selected>æœªé¸æŠ</option>
        <option value="nojimaInstall">åˆ†ãƒªã‚»</option>
        <option value="carrierInstall">ã‚­ãƒ£ãƒªã‚¢åˆ†å‰²</option>
        <option value="lump">ä¸€æ‹¬</option>
      </select>
    </div>

    <div id="s2TransferWrap">
      <label>ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ</label>
      <select id="s2NeedDataTransfer">
        <option value="no" selected>ãªã—</option>
        <option value="yes">ã‚ã‚Š</option>
      </select>
    </div>

    <div id="s2TradeWrap">
      <label>å¤ç‰©ä¸‹å–ã‚Šå—ä»˜</label>
      <select id="s2NeedTradeInReception">
        <option value="no" selected>ãªã—</option>
        <option value="yes">ã‚ã‚Š</option>
      </select>
    </div>
  </div>

  <div class="alert hidden" id="s2PointAlert" style="margin-top:10px;"></div>
</div>

    <div class="donebox hidden" id="attnBox">
      <b>âš  ã“ã“ã§ã®æ³¨æ„</b>
      <div class="checklist" id="attnList" style="margin-top:8px;"></div>
    </div>

    <div class="next hidden" id="nextBox">
      <b>ğŸ‘‰ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</b>
      <div id="nextAction" style="margin-top:6px;"></div>
    </div>

<!-- MNP(SIMã®ã¿ï¼‰å¥‘ç´„ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ -->
<div class="donebox hidden" id="s3SimChecklist">
  <div class="checklist" style="margin-top:8px;">

    <div class="checkitem">
      <input type="checkbox" id="chk_s3sim_mnp" />
      <div>
        <div class="ctitle">MNPäºˆç´„ç•ªå·ã®å–å¾—</div>
        <div class="csub">å–å¾—æ¸ˆã¿ãªã‚‰OKã€€è¤‡é›‘ãªå ´åˆã¯é›»è©±ã§</div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3sim_docs" />
      <div>
        <div class="ctitle">ã”æœ¬äººç¢ºèªæ›¸é¡ãƒ»ã‚«ãƒ¼ãƒ‰ã®ãŠé ã‹ã‚Š</div>
        <div class="csub">å¥‘ç´„æƒ…å ±å…¥åŠ›ã®ãŸã‚</div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3sim_input" />
      <div>
        <div class="ctitle">å¥‘ç´„æƒ…å ±ã‚’å…¥åŠ›</div>
        <div class="csub">æ°åã‚„ç”Ÿå¹´æœˆæ—¥ãªã©ã®å…¥åŠ›ãƒŸã‚¹ã«æ³¨æ„</div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3sim_notice" />
      <div>
        <div class="ctitle">é‡è¦äº‹é …èª¬æ˜å‹•ç”»ã®ã”æ¡ˆå†…</div>
        <div class="csub">å¥‘ç´„æƒ…å ±å…¥åŠ›ä¸­ã«ã”è¦§ã„ãŸã ãã¨ã‚¹ãƒ ãƒ¼ã‚º</div>
      </div>
    </div>

  </div>
</div>

<!-- åˆ†ãƒªã‚»å¯©æŸ»ãƒ»å¥‘ç´„ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ -->
<div class="donebox hidden" id="s3nChecklist">
  <div class="checklist" style="margin-top:8px;">
    <div class="checkitem">
      <input type="checkbox" id="chk_s3n_mnp" />
      <div>
        <div class="ctitle">MNPäºˆç´„ç•ªå·ã®å–å¾—</div>
        <div class="csub">å–å¾—æ¸ˆã¿ãªã‚‰OKã€€è¤‡é›‘ãªå ´åˆã¯é›»è©±ã§</div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3n_prepare" />
      <div>
        <div class="ctitle">ã”æœ¬äººç¢ºèªæ›¸é¡ãƒ»ã‚«ãƒ¼ãƒ‰ã®ãŠé ã‹ã‚Š</div>
        <div class="csub">åˆ†ãƒªã‚»ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ã®ã¿å¯ï¼ˆå¾Œæ—¥ç™»éŒ²å¯ï¼‰</div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3n_apply" />
      <div>
        <div class="ctitle">åˆ†ãƒªã‚»ã®ç”³è«‹</div>
        <div class="csub">ãƒ¢ãƒã‚¤ãƒ« â†’ å†…å®¹ç¢ºèª â†’ åˆ†ãƒªã‚»ç”¨QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š</div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3n_input" />
      <div>
        <div class="ctitle">å¥‘ç´„æƒ…å ±ã‚’å…¥åŠ›</div>
        <div class="csub">æ°åã‚„ç”Ÿå¹´æœˆæ—¥ãªã©ã®å…¥åŠ›ãƒŸã‚¹ã«æ³¨æ„ã€€<span class="legal">å¯©æŸ»çµæœãŒå‡ºã‚‹ã¾ã§ã¯ç¢ºå®šã—ãªã„</span></div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3n_video" />
      <div>
        <div class="ctitle">é‡è¦äº‹é …èª¬æ˜å‹•ç”»ã®ã”æ¡ˆå†…</div>
        <div class="csub">å¥‘ç´„æƒ…å ±å…¥åŠ›ä¸­ã«ã”è¦§ã„ãŸã ãã¨ã‚¹ãƒ ãƒ¼ã‚º</div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3n_result" />
      <div>
        <div class="ctitle">å¯©æŸ»çµæœã‚’ç¢ºèª</div>
        <div class="csub">OKãªã‚‰å¥‘ç´„ç¢ºå®šã¸ï¼NGãªã‚‰ä»£æ›¿æ¡ˆã¸</div>
      </div>
    </div>
  </div>
</div>

<!-- å¥‘ç´„å¾Œå¯¾å¿œã€€ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ -->
<div class="donebox hidden" id="doneChecklist">
  <div class="checklist" style="margin-top:8px;">
    <div class="checkitem">
      <input type="checkbox" id="chk_done_return" />
      <div>
        <div class="ctitle">ã”æœ¬äººç¢ºèªæ›¸é¡ãƒ»ã‚«ãƒ¼ãƒ‰ã®è¿”å´</div>
        <div class="csub">å…è¨±è¨¼ï¼ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ï¼ã‚¯ãƒ¬ã‚«ç­‰ã®è¿”ã—å¿˜ã‚Œé˜²æ­¢</div>
      </div>
    </div>
    <div class="checkitem">
      <input type="checkbox" id="chk_done_open" />
      <div>
        <div class="ctitle">é–‹é€šç¢ºèª</div>
        <div class="csub">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆé€šä¿¡ï¼ç™ºç€ä¿¡</div>
      </div>
    </div>
    <div class="checkitem hidden" id="doneDataTransferItem">
      <input type="checkbox" id="chk_done_datatransfer" />
      <div>
        <div class="ctitle">ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ</div>
        <div class="csub">æ–°ã—ã„ç«¯æœ«ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§ä¸å…·åˆé˜²æ­¢</div>
      </div>
    </div>
    <div class="checkitem">
      <input type="checkbox" id="chk_done_point" />
      <div>
        <div class="ctitle">POSã§ã®ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ãŠã‚ˆã³ãŠä¼šè¨ˆ</div>
        <div class="csub">ãƒ¢ãƒã‚¤ãƒ«QRã‚³ãƒ¼ãƒ‰ã®æœ‰åŠ¹æ™‚é–“ã‚„èª¤ç´ã¥ã‘ã«æ³¨æ„</div>
      </div>
    </div>
    <div class="checkitem">
      <input type="checkbox" id="chk_done_consent" />
      <div>
        <div class="ctitle">ãƒ‡ãƒ¼ã‚¿ç§»è¡ŒåŒæ„æ›¸ã®è¨˜å…¥</div>
        <div class="csub">ç¢ºèªäº‹é …ã®ãƒã‚§ãƒƒã‚¯ã¨ç½²å</div>
      </div>
    </div>
    <div class="checkitem hidden" id="doneTradeInItem">
      <input type="checkbox" id="chk_done_tradein" />
      <div>
        <div class="ctitle">å¤ç‰©ä¸‹å–ã‚Šå—ä»˜</div>
        <div class="csub">å½“æ—¥å—ä»˜ï¼å¾Œæ—¥å—ä»˜ã¯2é€±é–“ä»¥å†…</div>
      </div>
    </div>
    <div class="checkitem">
      <input type="checkbox" id="chk_done_car" />
      <div>
        <div class="ctitle">ãŠè»Šã®ã”åˆ©ç”¨ã‚’ç¢ºèª</div>
        <div class="csub">2æ™‚é–“é§è»Šåˆ¸ã®ãŠæ¸¡ã—ã€€è¶…éæ™‚ã¯ãƒãƒ«ã‚¨ãƒ„ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã¸èª˜å°</div>
      </div>
    </div>
  </div>
</div>

<div class="donebox hidden" id="multiFinishBox" style="text-align:center;">
  <div class="state" style="margin-bottom:6px;">âœ…ã“ã®å›ç·šã¯å®Œäº†</div>
  <div class="muted" id="multiFinishText" style="font-size:16px;">
    æ¬¡ã®å›ç·šã®å¥‘ç´„ã‚’é€²ã‚ã¦ãã ã•ã„
  </div>
  <div class="row" style="justify-content:center; margin-top:12px;">
    <button class="btn" id="gotoNextLineBtn">æ¬¡ã®å›ç·šã¸ â†’</button>
  </div>
</div>

<div class="donebox hidden" id="finishBox" style="text-align:center;">
  <div class="finishWrap">
    <div class="finishText">Completed!</div>
    <img
      src="img/otsukare.png"
      alt="ãŠç–²ã‚Œã•ã¾ã§ã—ãŸ"
      onerror="this.style.display='none'; document.getElementById('finishFallback').classList.remove('hidden');"
    />
  </div>
</div>

    <div class="row" id="navRow" style="margin-top:12px; align-items:center; width:100%;">
      <div class="row" style="gap:10px;">
        <button class="btn2" id="backBtn">â† æˆ»ã‚‹</button>
        <button class="btn" id="nextBtn">æ¬¡ã¸ â†’</button>
      </div>

      <div style="flex:1;"></div>
    </div>
  </div>
</div>

<script>
/* =========================
   Utils
   ========================= */
const el = (id) => document.getElementById(id);

function needsDeviceFlow(ct){
  return ct === "deviceChange" || ct === "mnpDevice" || ct === "new";
}
function isMnp(ct){
  return ct === "mnpDevice" || ct === "mnpSim";
}

/* =========================
   Storage
   ========================= */
const STORAGE_KEY = "contract_navi_ctx_v2_multi";

function blankLine(){
  return {
    form: {
      contractType:"", contractHolder:"self",
      userRelation:"self",
      carrier:"",
      dataUsage:"",
      chk_id_confirmed:false, chk_homeNet_asked:false,
      chk_tradein:false, tradeinResult:""
    },
    consult: { payType:"", needDataTransfer:"no", needTradeInReception:"no",toCarrier:"",
    toPlanKey:"" },
    flow:   { started:false, stepId:"S1" },
    s3:     { chk_s3sim_mnp:false, chk_s3sim_docs:false, chk_s3sim_input:false, chk_s3sim_notice:false },
    s3n:    { chk_s3n_mnp:false, chk_s3n_apply:false, chk_s3n_prepare:false, chk_s3n_input:false, chk_s3n_video:false, chk_s3n_result:false },
    s4:     { chk_done_return:false, chk_done_open:false, chk_done_datatransfer:false, chk_done_point:false, chk_done_consent:false, chk_done_tradein:false, chk_done_car:false },
    attn:   {}
  };
}

function readSharedSafe(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return { activeLine: 0, lines: [] };
  try {
    const obj = JSON.parse(raw) || {};
    obj.activeLine = Number.isInteger(obj.activeLine) ? obj.activeLine : 0;
    obj.lines = Array.isArray(obj.lines) ? obj.lines : [];
    return obj;
  } catch(e){
    return { activeLine: 0, lines: [] };
  }
}

function renderS2ToPlanOptions(selectedCarrier, selectedPlanKey){
  const planSel = el("s2ToPlanKey");
  if (!planSel) return;

  if (!selectedCarrier || !window.PRICE_DB?.getCarrier){
    planSel.innerHTML = `<option value="" selected>ã¾ãšã‚­ãƒ£ãƒªã‚¢ã‚’é¸æŠ</option>`;
    planSel.disabled = true;
    return;
  }

  const cc = window.PRICE_DB.getCarrier(selectedCarrier);
  const plans = cc?.plans || {};
  const keys = Object.keys(plans);

  if (keys.length === 0){
    planSel.innerHTML = `<option value="" selected>ãƒ—ãƒ©ãƒ³å®šç¾©ãªã—</option>`;
    planSel.disabled = true;
    return;
  }

  let html = `<option value="" ${!selectedPlanKey ? "selected" : ""}>æœªé¸æŠ</option>`;
  for (const k of keys){
    const p = plans[k];
    const label = p?.label || p?.name || k;
    const sel = (k === selectedPlanKey) ? "selected" : "";
    html += `<option value="${k}" ${sel}>${label}</option>`;
  }
  planSel.innerHTML = html;
  planSel.disabled = false;
}

function ensureLines(){
  const shared = readSharedSafe();
  if (shared.lines.length === 0){
    shared.lines.push(blankLine());
    shared.activeLine = 0;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));
  }
  // è‡ªå®…å›ç·šã¯åŸºæœ¬ä¸–å¸¯å…±é€š
  if (!shared.houseNet){
    shared.houseNet = { homeNetType:""};
  } else {
  if (shared.houseNet.housingType == null) shared.houseNet.housingType = "";
}

  localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));
  return shared;
}

let activeLine = 0;

function setActiveLine(i){
  const shared = ensureLines();
  const clamped = Math.max(0, Math.min(i, shared.lines.length - 1));
  shared.activeLine = clamped;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));
  activeLine = clamped;
}

/* =========================
   Labels
   ========================= */
function labelCarrier(v){
  return ({
    docomo:"docomo", ahamo:"ahamo", au:"au", uq:"UQ mobile",
    softbank:"SoftBank", ymobile:"Y!mobile", other:"ãã®ä»–",
    new:"æ–°è¦"
  })[v] || v;
}
function labelDataUsage(v){
  return ({ lte5:"ã€œ5GB", lte30:"ã€œ30GB", unlimited:"30GBä»¥ä¸Šï¼ˆç„¡åˆ¶é™ï¼‰" })[v] || v;
}
function labelUserRelation(v){
  return ({ self:"ã”æœ¬äºº", spouse:"é…å¶è€…", child:"ãŠå­æ§˜", parent:"ã”ä¸¡è¦ª", other:"ãã®ä»–" })[v] || v;
}
function labelHomeNetType(v){
  return ({
    docomohikari:"ãƒ‰ã‚³ãƒ¢å…‰", niftyhikari:"@niftyå…‰", softbankhikari:"ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯å…‰",
    otherntthikari:"ãã®ä»–ã‚³ãƒ©ãƒœå…‰", auhikari:"auã²ã‹ã‚Š", jcom:"J:COM",
    nurohikari:"NUROå…‰", fletshikari:"ãƒ•ãƒ¬ãƒƒãƒ„å…‰", home5g:"ãƒ›ãƒ¼ãƒ ãƒ«ãƒ¼ã‚¿",
    mobile:"ãƒ¢ãƒã‚¤ãƒ«ãƒ«ãƒ¼ã‚¿", none:"ãªã—", unknown:"ä¸æ˜"
  })[v] || v;
}

function labelPayType(v){
  return ({
    nojimaInstall:"ãƒã‚¸ãƒåˆ†å‰²",
    carrierInstall:"ã‚­ãƒ£ãƒªã‚¢åˆ†å‰²",
    lump:"ä¸€æ‹¬"
  })[v] || v;
}

function safePlanName(carrier, dataUsage){
  try{
    if (typeof PRICE_DB !== "undefined" && PRICE_DB.getPlan){
      const plan = PRICE_DB.getPlan(carrier, dataUsage);
      return plan?.name || plan?.planName || "";
    }
  }catch(e){}
  return "";
}

function isDeviceContractType(ct){
  return ct === "deviceChange" || ct === "mnpDevice" || ct === "new";
}

function updateS2UI(){
  const box = el("s2Box");
  if (!box) return;

  // S2 ã®ã¨ãã ã‘å‡ºã™
  const curStepId = (idx >= 0 && steps[idx]) ? steps[idx].id : "";
  const onS2 = (curStepId === "S2");
  box.classList.toggle("hidden", !onS2);
  if (!onS2) return;

  const shared = ensureLines();

const sum = el("s2LineSummary");
if (sum){
  const rows = shared.lines.map((ln, i)=>{
    const f = ln.form || {};
    const consult = ln.consult || {};

    const ct = f.contractType || "";
    const ur = f.userRelation || "self";

    const pay = consult.payType || "";
    const tr  = consult.needDataTransfer || "no";
    const ti  = consult.needTradeInReception || "no";
    const toC = consult.toCarrier || "";
    const toP = consult.toPlanKey || "";

    // å¥‘ç´„ã‚¿ã‚¤ãƒ—è¡¨ç¤ºï¼ˆå¿…é ˆï¼‰
    const ctLabel = ({
      mnpDevice: "MNPï¼ˆç«¯æœ«ã‚ã‚Šï¼‰",
      mnpSim: "MNPï¼ˆSIMã®ã¿ï¼‰",
      deviceChange: "æ©Ÿç¨®å¤‰æ›´",
      new: "ç´”æ–°è¦"
    })[ct] || "æœªé¸æŠ";

    // åˆ©ç”¨è€…ï¼ˆå¿…é ˆï¼‰
    const urLabel = labelUserRelation(ur) || "æœªé¸æŠ";

    // ä¹—ã‚Šæ›ãˆå…ˆã¯ MNP / ç´”æ–°è¦ã®ã¨ãã ã‘è‡ªç„¶ã«å‡ºã™ï¼ˆæ©Ÿç¨®å¤‰ã¯åŸºæœ¬ä¸è¦ï¼‰
    const showTo = (ct === "mnpDevice" || ct === "mnpSim" || ct === "new");

    // ä¹—ã‚Šæ›ãˆå…ˆãƒ—ãƒ©ãƒ³åï¼ˆtoCarrier/toPlanKey ãŒæƒã£ã¦ã„ã‚‹ã¨ãã ã‘ï¼‰
    let toPlanLabel = "";
    if (toC && toP && window.PRICE_DB?.getCarrier){
      const cc = window.PRICE_DB.getCarrier(toC);
      const p = cc?.plans?.[toP];
      toPlanLabel = p?.label || p?.name || toP;
    }

    // ç«¯æœ«ã‚ã‚Šç³»ï¼ˆè³¼å…¥/ç§»è¡Œ/ä¸‹å–ã‚’æ‰±ã†ï¼‰
    const deviceOps = needsDeviceFlow(ct);

    // --- 1è¡Œã«è©°ã‚ã™ããªã„ï¼špartsã¯ã€Œå¿…è¦ãªã‚‚ã®ã ã‘ã€ ---
    const parts = [];
    parts.push(`åˆ©ç”¨è€…ï¼š${urLabel}`);
    parts.push(ctLabel);

    if (showTo){
      parts.push(`ä¹—å…ˆï¼š${toC ? labelCarrier(toC) : "æœªé¸æŠ"}`);
      if (toC && toP) parts.push(`ãƒ—ãƒ©ãƒ³ï¼š${toPlanLabel || toP}`);
    }

    if (deviceOps){
      if (pay) parts.push(`è³¼å…¥ï¼š${labelPayType(pay)}`);
      if (tr === "yes") parts.push("ç§»è¡Œã‚ã‚Š");
      if (ti === "yes") parts.push("ä¸‹å–ã‚Šã‚ã‚Š");
    }

    const head = `å›ç·š ${i+1}${i===activeLine ? "ï¼ˆé¸æŠä¸­ï¼‰" : ""}`;

    return `<div style="padding:8px 0; border-bottom:1px solid #eef0f3;">
      <b>${head}</b>
      <div>${parts.join(" / ")}</div>
    </div>`;
  }).join("");

  sum.innerHTML = rows || "ã¾ã å›ç·šãŒã‚ã‚Šã¾ã›ã‚“";
}

  // --- S2 ç·¨é›†å¯¾è±¡ï¼ˆé¸æŠä¸­ã®å›ç·šï¼‰ ---
  const line = shared.lines[activeLine];
  line.consult = line.consult || { payType:"", needDataTransfer:"no", needTradeInReception:"no" };

  const ct = (line.form?.contractType || el("contractType")?.value || "");
  const showDeviceOps = isDeviceContractType(ct);

  const showToPlan = (ct === "mnpDevice" || ct === "mnpSim" || ct === "new");
  el("s2ToCarrierWrap")?.classList.toggle("hidden", !showToPlan);
  el("s2ToPlanWrap")?.classList.toggle("hidden", !showToPlan);

  // ç«¯æœ«ã‚ã‚Šç³»ã˜ã‚ƒãªã„ãªã‚‰ã€è³¼å…¥æ–¹æ³•/ç§»è¡Œ/ä¸‹å–ã‚Šã¯éš ã™
  el("s2PayWrap")?.classList.toggle("hidden", !showDeviceOps);
  el("s2TransferWrap")?.classList.toggle("hidden", !showDeviceOps);
  el("s2TradeWrap")?.classList.toggle("hidden", !showDeviceOps);

  // å€¤ã‚’åæ˜ 
  if (el("s2PayType")) el("s2PayType").value = line.consult.payType || "";
  if (el("s2NeedDataTransfer")) el("s2NeedDataTransfer").value = line.consult.needDataTransfer || "no";
  if (el("s2NeedTradeInReception")) el("s2NeedTradeInReception").value = line.consult.needTradeInReception || "no";

  const toCarrier = line.consult.toCarrier || "";
  const toPlanKey = line.consult.toPlanKey || "";

  if (el("s2ToCarrier")) el("s2ToCarrier").value = toCarrier;

  // toCarrierã«å¿œã˜ã¦ãƒ—ãƒ©ãƒ³å€™è£œã‚’ä½œã‚‹ï¼ˆshowToPlan=false ã§ã‚‚å£Šã‚Œãªã„ï¼‰
  renderS2ToPlanOptions(toCarrier, toPlanKey);

  // æ³¨æ„ï¼šMNPï¼ˆç«¯æœ«ã‚ã‚Šï¼‰ + (ã‚­ãƒ£ãƒªã‚¢åˆ†å‰² or ä¸€æ‹¬) + ä¸‹å–ã‚Šãªã— â†’ ãƒã‚¤ãƒ³ãƒˆNG
  const pointAlert = el("s2PointAlert");
  if (pointAlert){
    const pay = line.consult.payType || "";
    const ti  = line.consult.needTradeInReception || "no";
    const isBad = (ct === "mnpDevice") && (pay === "carrierInstall" || pay === "lump") && (ti === "no");
    pointAlert.classList.toggle("hidden", !isBad);
    pointAlert.textContent = isBad
      ? "ã€æ³¨æ„ã€‘è³¼å…¥æ–¹æ³•ãŒã€Œã‚­ãƒ£ãƒªã‚¢åˆ†å‰²ï¼ä¸€æ‹¬ã€ã‹ã¤ã€Œä¸‹å–ã‚Šãªã—ã€ã®å ´åˆã€ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ãŒã§ãã¾ã›ã‚“ï¼ˆä¸‹å–ã‚Šå—ä»˜ã®æœ‰ç„¡ã‚’å†ç¢ºèªï¼‰"
      : "";
  }
}

function saveS2ConsultPatch(patch){
  const shared = ensureLines();
  const line = shared.lines[activeLine];
  line.consult = line.consult || { payType:"", needDataTransfer:"no", needTradeInReception:"no" };
  line.consult = { ...line.consult, ...patch };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));
}

/* =========================
   State
   ========================= */
let ctx = null;
let steps = [];
let idx = -1;

/* =========================
   Steps
   ========================= */
function buildSteps(contractType, payType) {
  const s = [];
  s.push({ id: "S2", name: "2. ãƒ—ãƒ©ãƒ³ã®ã‚³ãƒ³ã‚µãƒ«" });

  if (!needsDeviceFlow(contractType)) {
    s.push({ id: "S3", name: "3. å¥‘ç´„" });
    s.push({ id: "S4", name: "4. å¥‘ç´„å¾Œå¯¾å¿œ" });
    s.push({ id: "S5", name: "ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼" });
    return s;
  }

  if (!payType) return s;

  if (payType === "nojimaInstall") {
    s.push({ id: "S3N", name: "3. åˆ†ãƒªã‚»å¯©æŸ»ãƒ»å¥‘ç´„" });
    s.push({ id: "S4", name: "4. å¥‘ç´„å¾Œå¯¾å¿œ" });
    s.push({ id: "S5", name: "ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼" });
    return s;
  }

  if (payType === "carrierInstall") {
    s.push({ id: "S3C", name: "3. åˆ†å‰²å¯©æŸ»ãƒ»å¥‘ç´„" });
    s.push({ id: "S4", name: "4. å¥‘ç´„å¾Œå¯¾å¿œ" });
    s.push({ id: "S5", name: "ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼" });
    return s;
  }

  s.push({ id: "S3", name: "3. å¥‘ç´„" });
  s.push({ id: "S4", name: "4. å¥‘ç´„å¾Œå¯¾å¿œ" });
  s.push({ id: "S5", name: "ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼" });
  return s;
}

/* =========================
   Business logic
   ========================= */
function needsTradeInChecklist(ct){
  return ct === "deviceChange" || ct === "mnpDevice";
}

/* =========================
   UI: badges / preAlert
   ========================= */
function updateTradeInVisibility(){
  const ct = el("contractType").value;
  const block = el("tradeinBlock");
  if (needsTradeInChecklist(ct)){
    block.classList.remove("hidden");
  } else {
    el("chk_tradein").checked = false;
    if (el("tradeinResult")) el("tradeinResult").value = "";
    block.classList.add("hidden");
  }
  updateBadges();
}
function sectionDone(ids){
  return ids.every(id => {
    const node = el(id);
    if (!node) return false;
    if (node.type === "checkbox") return node.checked;
    return (node.value || "").trim() !== "";
  });
}

function setDone(id, ok){
  const b = el(id);
  if (!b) return;
  b.classList.toggle("done", ok);
}

function updateBadges(){
  const basicOk  = sectionDone(["contractType","contractHolder"]);
  const creditOk = sectionDone(["carrier","usageYears","dataUsage","homeNetType"]);
  setDone("badge_basic",  basicOk);
  setDone("badge_credit", creditOk);

  const ct = el("contractType").value;
  const baseChecksOk = sectionDone(["chk_id_confirmed","chk_homeNet_asked"]);
  const tradeOk = needsTradeInChecklist(ct)
    ? (el("chk_tradein").checked && (el("tradeinResult") ? (el("tradeinResult").value || "").trim() !== "" : false))
    : true;

  setDone("badge_check", baseChecksOk && tradeOk);
}

function updatePreAlert(){
  const box = el("preAlert");
  if (!box) return;
  box.classList.add("hidden");
  box.textContent = "";
}

function allSelected(){
  const requiredSelects = [
  "contractType","contractHolder",
  "carrier","dataUsage","homeNetType"
];

if (activeLine === 0){
    requiredSelects.push("homeNetType");
  }
  const okSel = requiredSelects.every(id => (el(id).value || "").trim() !== "");
  if (!okSel) return false;

  if (!el("chk_id_confirmed").checked) return false;
  if (!el("chk_homeNet_asked").checked) return false;

  const ct = el("contractType").value;
  if (needsTradeInChecklist(ct)){
    if (!el("chk_tradein").checked) return false;
    if (!el("tradeinResult") || (el("tradeinResult").value || "").trim() === "") return false;
  }
  return true;
}

let prevCarrier = "";
let prevUsageYears = "";

// ç´”æ–°è¦ãªã‚‰ã°ã‚­ãƒ£ãƒªã‚¢ã¯æ–°è¦ã§å›ºå®š
function ensureCarrierNewOption(){
  const carrierEl = el("carrier");
  if (!carrierEl) return null;

  let opt = carrierEl.querySelector('option[value="new"]');
  if (!opt){
    opt = document.createElement("option");
    opt.value = "new";
    opt.textContent = "æ–°è¦";
    carrierEl.appendChild(opt);
  }
  return opt;
}

function removeCarrierNewOption(){
  const carrierEl = el("carrier");
  if (!carrierEl) return;
  const opt = carrierEl.querySelector('option[value="new"]');
  if (opt) opt.remove();
}

function ensureUsageYearsNewOption(){
  const yearsEl = el("usageYears");
  if (!yearsEl) return null;

  let opt = yearsEl.querySelector('option[value="new"]');
  if (!opt){
    opt = document.createElement("option");
    opt.value = "new";
    opt.textContent = "æ–°è¦";
    yearsEl.appendChild(opt);
  }
  return opt;
}

function removeUsageYearsNewOption(){
  const yearsEl = el("usageYears");
  if (!yearsEl) return;
  const opt = yearsEl.querySelector('option[value="new"]');
  if (opt) opt.remove();
}

function syncNewDeviceLocks(){
  const ct = el("contractType")?.value;
  const carrierEl = el("carrier");
  const yearsEl   = el("usageYears");
  if (!carrierEl || !yearsEl) return;

  const lock = (ct === "new");

  if (lock){
    ensureCarrierNewOption();
    ensureUsageYearsNewOption();

    if (!prevCarrier) prevCarrier = carrierEl.value || "";
    if (!prevUsageYears) prevUsageYears = yearsEl.value || "";

    // å¼·åˆ¶å›ºå®š
    carrierEl.value = "new";
    yearsEl.value   = "new";
    carrierEl.disabled = true;
    yearsEl.disabled   = true;

  } else {
    carrierEl.disabled = false;
    yearsEl.disabled   = false;

    if (carrierEl.value === "new") carrierEl.value = prevCarrier || "";
    if (yearsEl.value === "new")   yearsEl.value   = prevUsageYears || "";

    removeCarrierNewOption();
    removeUsageYearsNewOption();

    prevCarrier = "";
    prevUsageYears = "";
  }
}

function syncUserRelationLock(){
  const ur = el("userRelation");
  if (!ur) return;
  ur.disabled = false;
}

function updateStartEnabled(){
  el("startBtn").disabled = !allSelected();
  updatePreAlert();
  updateBadges();
}

function updateContractHolderOptions(){
  const shared = ensureLines();
  const sel = el("contractHolder");
  if (!sel) return;

  const isMulti = shared.lines.length >= 2;

  const mapSingle = {
    self: "ã”æœ¬äºº",
    spouse: "é…å¶è€…",
    child: "ãŠå­æ§˜",
    parent: "ã”ä¸¡è¦ª",
    other: "ãã®ä»–"
  };

  const mapMulti = {
    self: "ä»£è¡¨è€…ï¼ˆã”æœ¬äººï¼‰",
    spouse: "é…å¶è€…",
    child: "ãŠå­æ§˜",
    parent: "ã”ä¸¡è¦ª",
    other: "ãã®ä»–"
  };

  const map = isMulti ? mapMulti : mapSingle;

  Array.from(sel.options).forEach(opt => {
    if (map[opt.value]) {
      opt.textContent = map[opt.value];
    }
  });
}

/* =========================
   Step content
   ========================= */
function contentFor(stepId, ctx){
  const warn = [];
  let next = "";

  if (stepId === "S1"){
    warn.push("ä¸ä¿¡ã«ã¯ã”æœ¬äººç¢ºèªæ›¸é¡ãŒå¿…è¦ã§ã™");
    if (ctx.contractType === "deviceChange" || ctx.contractType === "mnpDevice"){
      warn.push("åˆ†å‰²ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ã”åˆ©ç”¨ã®å ´åˆã€ç«¯æœ«ã®æ®‹å‚µã‚’ç¢ºèª");
    }

    if (ctx.userRelation !== "self") warn.push("ã”åˆ©ç”¨è€…æ§˜ãŒã”æœ¬äººä»¥å¤–ï¼šå¥‘ç´„åç¾©ãƒ»åŒæ„/ç¢ºèªäº‹é …ã®æ•´ç†ãŒå¿…è¦ã§ã™");
    if (ctx.homeNetType === "none") warn.push("è‡ªå®…å›ç·šãªã—ï¼šå¿…è¦ãªã‚‰å›ç·šææ¡ˆã®æœ‰ç„¡ã‚’ç¢ºèª");

    next = "ãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚’ã‚‚ã¨ã«ãƒ—ãƒ©ãƒ³ã®ã‚³ãƒ³ã‚µãƒ«ã‚’è¡Œã†";
  }

  if (stepId === "S2"){
    warn.push("æ–½ç­–ã®é©ç”¨æ¡ä»¶ã‚„å¿…é ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ç­‰ã‚’æ˜ç¢ºã«ã”èª¬æ˜ã™ã‚‹");

    if (ctx.dataUsage === "lte5") warn.push("ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨é‡ãŒå°‘ãªã‚æƒ³å®šï¼ˆï½5GBï¼‰");
    if (ctx.dataUsage === "lte30") warn.push("ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨é‡ãŒä¸­ç¨‹åº¦æƒ³å®š(ï½30GBï¼‰");
    if (ctx.dataUsage === "unlimited") warn.push("ç„¡åˆ¶é™ãƒ—ãƒ©ãƒ³æƒ³å®š");
    if (ctx.carrier === "uq" && (ctx.usageYears === "gt6m")){
      warn.push("UQ mobile ã‚’6ã‹æœˆä»¥ä¸Šåˆ©ç”¨ï¼šauã¸ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å‰²å¼•ã®å¯¾è±¡ç¢ºèª");
    }
    if (ctx.carrier === "ymobile" && (ctx.usageYears === "gt6m")){
      warn.push("Y!mobile ã‚’6ã‹æœˆä»¥ä¸Šåˆ©ç”¨ï¼šSoftBankã¸ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å‰²å¼•ã®å¯¾è±¡ç¢ºèª");
    }

    if (needsDeviceFlow(ctx.contractType) && !ctx.payType){
      next = "ã‚­ãƒ£ãƒªã‚¢ãƒ‘ãƒ¬ãƒƒãƒˆã§ã‚­ãƒ£ãƒªã‚¢ã®ã‚³ãƒ³ã‚µãƒ«ã‚’è¡Œã†";
    } else if (!needsDeviceFlow(ctx.contractType)){
      next = "ã”æœ¬äººç¢ºèªæ›¸é¡ãŠã‚ˆã³ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ã‚’ãŠé ã‹ã‚Šã—ã€å¥‘ç´„ã¸é€²ã‚€";
    } else if (ctx.payType === "nojimaInstall"){
      next = "ã”æœ¬äººç¢ºèªæ›¸é¡ãŠã‚ˆã³ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ã‚’ãŠé ã‹ã‚Šã—ã€åˆ†ãƒªã‚»å¯©æŸ»ãƒ»å¥‘ç´„ã¸é€²ã‚€";
    } else {
      next = "ã”æœ¬äººç¢ºèªæ›¸é¡ãŠã‚ˆã³ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ã‚’ãŠé ã‹ã‚Šã—ã€å¥‘ç´„ã¸é€²ã‚€";
    }
  }

  if (stepId === "S3"){
    warn.push("ã”æœ¬äººç¢ºèªæ›¸é¡ãŠã‚ˆã³ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ã‚’ãŠé ã‹ã‚Šã™ã‚‹");
    warn.push("ãŠå®¢æ§˜ã«ã¯ã“ã®é–“ã«é‡è¦äº‹é …èª¬æ˜å‹•ç”»ã‚’ã”è¦§ã„ãŸã ã");
    next = "å¥‘ç´„ã‚’å®Œäº†ã—ã€å¥‘ç´„å¾Œå¯¾å¿œã«é€²ã‚€";
  }

  if (stepId === "S3N"){
    warn.push("ãŠå®¢æ§˜ã®ãƒ¢ãƒã‚¤ãƒ«QRã‚³ãƒ¼ãƒ‰ã‚’ã„ãŸã ãã€åˆ†å‰²ã®ç”³è«‹ã‚’è¡Œã†");
    warn.push("å¯©æŸ»ã¨ä¸¦è¡Œã—ã¦å¥‘ç´„å…¥åŠ›ã‚’è¡Œã†ãŒã€å¯©æŸ»çµæœãŒå‡ºã‚‹ã¾ã§ã¯ç™»éŒ²ã‚’ç¢ºå®šã—ãªã„");
    warn.push("ãŠå®¢æ§˜ã«ã¯ã“ã®é–“ã«é‡è¦äº‹é …èª¬æ˜å‹•ç”»ã‚’ã”è¦§ã„ãŸã ã");
    next = "å¯©æŸ»çµæœã‚’ç¢ºèªå¾Œã€å¥‘ç´„ã‚’å®Œäº†ã™ã‚‹";
  }

  if (stepId === "S3C"){
    warn.push("å¯©æŸ»çµæœã«ã‚ˆã‚Šã€åˆ†å‰²ä¸å¯â†’ä¸€æ‹¬ã®ã¿ã¨ãªã‚‹å¯èƒ½æ€§ã‚‚");
    warn.push("ãŠå®¢æ§˜ã«ã¯ã“ã®é–“ã«é‡è¦äº‹é …èª¬æ˜å‹•ç”»ã‚’ã”è¦§ã„ãŸã ã");
    next = "å¯©æŸ»çµæœã‚’ç¢ºèªå¾Œã€å¥‘ç´„ã‚’å®Œäº†ã™ã‚‹";
  }

  if (stepId === "S4"){
    if (ctx.contractType === "mnpDevice"
      && (ctx.payType === "carrierInstall" || ctx.payType === "lump")
      && (ctx.needTradeInReception === "no")){
      warn.push("ã€æ³¨æ„ã€‘è³¼å…¥æ–¹æ³•ãŒã€Œã‚­ãƒ£ãƒªã‚¢åˆ†å‰²ï¼ä¸€æ‹¬ã€ã‹ã¤ã€Œä¸‹å–ã‚Šãªã—ã€ã®å ´åˆã€ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ãŒã§ãã¾ã›ã‚“ï¼ˆä¸‹å–ã‚Šå—ä»˜ã®æœ‰ç„¡ã‚’å†ç¢ºèªï¼‰");
    }
    warn.push("ã”æœ¬äººç¢ºèªæ›¸é¡ãƒ»ã‚«ãƒ¼ãƒ‰é¡ã‚’ç¢ºå®Ÿã«ãŠè¿”ã—ã™ã‚‹");
    warn.push("ãƒ‡ãƒ¼ã‚¿ç§»è¡ŒåŒæ„æ›¸ã«ã”ç½²åã„ãŸã ã");
    next = "é–‹é€šç¢ºèªã‚„ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚’è¡Œã†";
  }

  return { warn, next };
}

/* =========================
   Checklist gates
   ========================= */
function requiredDoneIds(curCtx){
  const ids = ["chk_done_return","chk_done_open","chk_done_point","chk_done_consent"];
  const deviceFlow = needsDeviceFlow(curCtx.contractType);
  if (deviceFlow && curCtx.needDataTransfer === "yes") ids.push("chk_done_datatransfer");
  if (deviceFlow && curCtx.needTradeInReception === "yes") ids.push("chk_done_tradein");
  const shared = ensureLines();
  const isLastLine = (activeLine === shared.lines.length - 1);
  if (isLastLine) ids.push("chk_done_car");
  return ids;
}
function isS3SimChecklistComplete(curCtx){
  const ids = ["chk_s3sim_mnp","chk_s3sim_docs","chk_s3sim_input","chk_s3sim_notice"];
  return ids.every(id => el(id) && el(id).checked);
}
function isS3NChecklistComplete(curCtx){
  const ids = ["chk_s3n_apply","chk_s3n_prepare","chk_s3n_input","chk_s3n_video","chk_s3n_result"];
  if (isMnp(curCtx.contractType)) ids.unshift("chk_s3n_mnp");
  return ids.every(id => el(id) && el(id).checked);
}
function isDoneChecklistComplete(curCtx){
  const ids = requiredDoneIds(curCtx);
  return ids.every(id => el(id) && el(id).checked);
}

/* =========================
   Render
   ========================= */
function render(){
  if (el("finishBox")) el("finishBox").classList.add("hidden");
  if (el("multiFinishBox")) el("multiFinishBox").classList.add("hidden");
  const bar = el("stepbar");
  bar.innerHTML = "";

  if (el("attnBox")) el("attnBox").classList.add("hidden");
  if (el("attnList")) el("attnList").innerHTML = "";
  if (el("nextBox")) el("nextBox").classList.add("hidden");
  if (el("nextAction")) el("nextAction").textContent = "";

  if (el("warnBox")) el("warnBox").classList.add("hidden");

  if (idx < 0){
    el("stepTitle").textContent = "é–‹å§‹ã—ã¦ãã ã•ã„";
    if (el("attnBox")) el("attnBox").classList.add("hidden");
    el("nextBox").classList.add("hidden");
    el("doneChecklist").classList.add("hidden");
    el("finishBox").classList.add("hidden");
    if (el("s3SimChecklist")) el("s3SimChecklist").classList.add("hidden");
    if (el("s3nChecklist")) el("s3nChecklist").classList.add("hidden");
    el("backBtn").disabled = true;
    el("nextBtn").disabled = true;
    return;
  }

  const STEPBAR_VISIBLE_IDS = ["S1","S2","S3","S3N","S3C","S4"];
  steps.forEach((s, i) => {
    if (!STEPBAR_VISIBLE_IDS.includes(s.id)) return;
    const d = document.createElement("div");
    d.className = "step" + (i === idx ? " current" : (i < idx ? " done" : ""));
    d.textContent = s.name;
    d.onclick = () => { idx = i; saveFlowState(); render();  };
    bar.appendChild(d);
  });

  const step = steps[idx];
  const navRow = el("navRow");
  if (navRow) navRow.classList.toggle("hiddenRow", step.id === "S2");
  el("stepTitle").textContent = step.name;


  // S5
if (step.id === "S5"){
  if (el("warnBox")) el("warnBox").classList.add("hidden");
  el("nextBox").classList.add("hidden");
  el("doneChecklist").classList.add("hidden");
  if (el("s3SimChecklist")) el("s3SimChecklist").classList.add("hidden");
  if (el("s3nChecklist")) el("s3nChecklist").classList.add("hidden");

  const nextIdx = findNextIncompleteLineIndex();

  // å…¨å›ç·šå®Œäº† â†’ ã€ŒãŠç–²ã‚Œã•ã¾ã§ã—ãŸã€
  if (nextIdx < 0){
    el("multiFinishBox")?.classList.add("hidden");
    el("finishBox").classList.remove("hidden");
    el("backBtn").disabled = (idx === 0);
    el("nextBtn").disabled = true;
    return;
  }

  // æœªå®Œã®å›ç·šãŒæ®‹ã£ã¦ã‚‹ â†’ æ¬¡ã®å›ç·šã¸èª˜å°
  el("finishBox").classList.add("hidden");
  el("multiFinishBox")?.classList.remove("hidden");

  if (el("multiFinishText")){
    el("multiFinishText").textContent = `ã¾ã æœªå®Œã®å›ç·šãŒã‚ã‚Šã¾ã™ã€‚å›ç·š ${nextIdx+1} ã®å¥‘ç´„ã‚’é€²ã‚ã¦ãã ã•ã„ã€‚`;
  }

  // ãƒœã‚¿ãƒ³å‹•ä½œ
  if (el("gotoNextLineBtn")){
    el("gotoNextLineBtn").onclick = () => gotoLine(nextIdx);
  }

  el("backBtn").disabled = (idx === 0);
  el("nextBtn").disabled = true;
  return;
}

  // S3 SIM-only checklist
  if (step.id === "S3" && ctx && ctx.contractType === "mnpSim"){
    if (el("warnBox")) el("warnBox").classList.add("hidden");
    el("nextBox").classList.add("hidden");
    el("doneChecklist").classList.add("hidden");
    el("finishBox").classList.add("hidden");
    if (el("s3nChecklist")) el("s3nChecklist").classList.add("hidden");
    el("s3SimChecklist").classList.remove("hidden");

    el("backBtn").disabled = (idx === 0);
    el("nextBtn").disabled = !isS3SimChecklistComplete(ctx);
    return;
  } else {
    if (el("s3SimChecklist")) el("s3SimChecklist").classList.add("hidden");
  }

  // S3N checklist
  if (step.id === "S3N"){
    if (el("warnBox")) el("warnBox").classList.add("hidden");
    el("nextBox").classList.add("hidden");
    el("doneChecklist").classList.add("hidden");
    el("finishBox").classList.add("hidden");
    if (el("s3SimChecklist")) el("s3SimChecklist").classList.add("hidden");
    el("s3nChecklist").classList.remove("hidden");

    el("backBtn").disabled = (idx === 0);
    el("nextBtn").disabled = !isS3NChecklistComplete(ctx);
    return;
  } else {
    if (el("s3nChecklist")) el("s3nChecklist").classList.add("hidden");
  }

  // S4 done checklist
  if (step.id === "S4"){
    if (el("warnBox")) el("warnBox").classList.add("hidden");
    el("nextBox").classList.add("hidden");
    el("finishBox").classList.add("hidden");
    el("doneChecklist").classList.remove("hidden");

    el("doneDataTransferItem").classList.toggle("hidden", ctx.needDataTransfer !== "yes");
    el("doneTradeInItem").classList.toggle("hidden", ctx.needTradeInReception !== "yes");

    const shared = ensureLines();
    const isLastLine = (activeLine === shared.lines.length - 1);
    const carItem = el("chk_done_car")?.closest(".checkitem");
    if (carItem) carItem.classList.toggle("hidden", !isLastLine);

    el("backBtn").disabled = (idx === 0);
    el("nextBtn").disabled = !isDoneChecklistComplete(ctx);
    return;
  }

// default: S1/S2/S3*/S3C
el("doneChecklist").classList.add("hidden");
el("finishBox").classList.add("hidden");

if (el("attnBox")) el("attnBox").classList.add("hidden");
if (el("nextBox")) el("nextBox").classList.add("hidden");

// S2 ã¯ã€Œã‚³ãƒ³ã‚µãƒ«ãƒ„ãƒ¼ãƒ«ã¸ã€ãƒœã‚¿ãƒ³ã ã‘å‡ºã™ï¼ˆæ–‡ç« ã¯å‡ºã•ãªã„ï¼‰
if (step.id === "S2") {
  // stepTitle ã¯æ—¢ã«ã‚»ãƒƒãƒˆæ¸ˆã¿
}
updateS2UI();
el("backBtn").disabled = (idx === 0);
el("nextBtn").disabled = (idx === steps.length - 1);
}

/* =========================
   Draft save/load (per line)
   ========================= */
function collectForm(){
  const shared = ensureLines();

  return {
    contractType: el("contractType").value,
    contractHolder: el("contractHolder").value,
    userRelation: el("userRelation").value,

    carrier: el("carrier").value,
    dataUsage: el("dataUsage").value,

    homeNetType:  (shared.houseNet?.homeNetType || ""),

    chk_id_confirmed: el("chk_id_confirmed").checked,
    chk_homeNet_asked: el("chk_homeNet_asked").checked,
    chk_tradein: el("chk_tradein").checked,
    tradeinResult: (el("tradeinResult") ? el("tradeinResult").value : "")
  };
}
function saveDraft(){
  const shared = ensureLines();

  shared.lines[activeLine].form = { ...collectForm() };
  if (activeLine === 0){
    shared.houseNet.homeNetType  = el("homeNetType").value  || "";
  }

  localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));
}

function loadDraft(){
  const shared = ensureLines();
  const data = shared.lines[activeLine].form || {};
  const setVal = (id, v) => { if (v != null && el(id)) el(id).value = v; };

  setVal("contractType", data.contractType);
  updateTradeInVisibility();

  setVal("contractHolder", data.contractHolder ?? "self");

syncUserRelationLock();
setVal("userRelation", data.userRelation ?? "self");

  setVal("userRelation", data.userRelation);
  setVal("carrier", data.carrier);
  setVal("dataUsage", data.dataUsage);
  setVal("homeNetType",  shared.houseNet.homeNetType  || "");

  el("chk_id_confirmed").checked = !!data.chk_id_confirmed;
  el("chk_homeNet_asked").checked = !!data.chk_homeNet_asked;
  el("chk_tradein").checked = !!data.chk_tradein;
  if (el("tradeinResult")) el("tradeinResult").value = data.tradeinResult || "";

  syncNewDeviceLocks();
  updateStartEnabled();
}

/* =========================
   Flow state save/restore
   ========================= */
function saveFlowState(){
  const shared = ensureLines();
  shared.lines[activeLine].flow.started = !!(ctx && idx >= 0);
  shared.lines[activeLine].flow.stepId  = (steps[idx] ? steps[idx].id : "S1");
  localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));
}

function restoreCheckStatesFromLine(line){
  const s3 = line.s3 || {};
  ["chk_s3sim_mnp","chk_s3sim_docs","chk_s3sim_input","chk_s3sim_notice"].forEach(id=>{
    if (el(id)) el(id).checked = !!s3[id];
  });

  const s3n = line.s3n || {};
  ["chk_s3n_mnp","chk_s3n_apply","chk_s3n_prepare","chk_s3n_input","chk_s3n_video","chk_s3n_result"].forEach(id=>{
    if (el(id)) el(id).checked = !!s3n[id];
  });

  const s4 = line.s4 || {};
  ["chk_done_return","chk_done_open","chk_done_datatransfer","chk_done_point","chk_done_consent","chk_done_tradein","chk_done_car"].forEach(id=>{
    if (el(id)) el(id).checked = !!s4[id];
  });
}

function saveChecklistToLine(){
  const shared = ensureLines();
  const line = shared.lines[activeLine];

  line.s3 = line.s3 || {};
  ["chk_s3sim_mnp","chk_s3sim_docs","chk_s3sim_input","chk_s3sim_notice"].forEach(id=>{
    if (el(id)) line.s3[id] = !!el(id).checked;
  });

  line.s3n = line.s3n || {};
  ["chk_s3n_mnp","chk_s3n_apply","chk_s3n_prepare","chk_s3n_input","chk_s3n_video","chk_s3n_result"].forEach(id=>{
    if (el(id)) line.s3n[id] = !!el(id).checked;
  });

  line.s4 = line.s4 || {};
  ["chk_done_return","chk_done_open","chk_done_datatransfer","chk_done_point","chk_done_consent","chk_done_tradein","chk_done_car"].forEach(id=>{
    if (el(id)) line.s4[id] = !!el(id).checked;
  });

  localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));
}

function getAttnState(stepId){
  const shared = ensureLines();
  const line = shared.lines[activeLine];
  line.attn = line.attn || {};
  line.attn[stepId] = line.attn[stepId] || {};
  return { shared, line, state: line.attn[stepId] };
}

function setAttnChecked(stepId, key, val){
  const { shared, line, state } = getAttnState(stepId);
  state[key] = !!val;
  line.attn[stepId] = state;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));
}

function isAttnComplete(stepId, keys){
  const { state } = getAttnState(stepId);
  return keys.every(k => !!state[k]);
}

function findNextIncompleteLineIndex(){
  const shared = ensureLines();
  for (let i = 0; i < shared.lines.length; i++){
    const flow = shared.lines[i].flow || {};
    if (!flow.started) return i;
    if ((flow.stepId || "S1") !== "S5") return i;
  }
  return -1;
}

function gotoLine(i){
  saveDraft();
  saveFlowState();
  saveChecklistToLine();
  setActiveLine(i);
  syncFromStorage();
}

/* =========================
   Multi line bar
   ========================= */
function renderLinebar(){
  if (el("finishBox")) el("finishBox").classList.add("hidden");
  if (el("multiFinishBox")) el("multiFinishBox").classList.add("hidden");

  const linebar = el("linebar");
  if (!linebar) return;

  const shared = ensureLines();
  activeLine = Math.max(0, Math.min(shared.activeLine, shared.lines.length - 1));

  linebar.innerHTML = "";
  shared.lines.forEach((_, i)=>{
    const d = document.createElement("div");
    const isCur = (i === activeLine);
    d.className = "step" + (isCur ? " current" : "");
    d.textContent = `å›ç·š ${i+1}`;
    d.onclick = () => {
      saveDraft();
      saveFlowState();
      saveChecklistToLine();
      setActiveLine(i);
      syncFromStorage();
    };
    linebar.appendChild(d);
  });

  if (el("removeLineBtn")){
    el("removeLineBtn").disabled = (shared.lines.length <= 1);
  }
  renderLinebarMini();
  updateContractHolderOptions();
}

function renderLinebarMini(){
  const bar = el("linebarMini");
  if (!bar) return;

  const shared = ensureLines();
  activeLine = Math.max(0, Math.min(shared.activeLine, shared.lines.length - 1));

  bar.innerHTML = "";
  shared.lines.forEach((_, i) => {
    const d = document.createElement("div");
    d.className = "step" + (i === activeLine ? " current" : "");
    d.textContent = `å›ç·š ${i+1}`;
    d.onclick = () => gotoLine(i);
    bar.appendChild(d);
  });
}

function decideS3StartId(curCtx){
  // SIMã®ã¿ or ç«¯æœ«ãƒ•ãƒ­ãƒ¼ä¸è¦ â†’ S3
  if (!needsDeviceFlow(curCtx.contractType)) return "S3";
  if (curCtx.contractType === "mnpSim") return "S3";

  // ç«¯æœ«ã‚ã‚Šãƒ•ãƒ­ãƒ¼
  if (curCtx.payType === "nojimaInstall")   return "S3N";
  if (curCtx.payType === "carrierInstall")  return "S3C";
  // lump / æœªæŒ‡å®š ã¯é€šå¸¸å¥‘ç´„ã¸
  return "S3";
}

/* =========================
   Sync from storage
   ========================= */
function syncFromStorage(){
  const shared = ensureLines();
  activeLine = Math.max(0, Math.min(shared.activeLine, shared.lines.length - 1));
  const line = shared.lines[activeLine];

  loadDraft();
  restoreCheckStatesFromLine(line);

  const consult = line.consult || { payType:"", needDataTransfer:"no", needTradeInReception:"no" };
  const started = !!(line.flow && line.flow.started);

  if (!started){
    ctx = null; steps = []; idx = -1;
    render();
    renderLinebar();
    return;
  }

  ctx = {
    ...collectForm(),
    payType: consult.payType || "",
    needDataTransfer: consult.needDataTransfer || "no",
    needTradeInReception: consult.needTradeInReception || "no",
  };

  steps = buildSteps(ctx.contractType, ctx.payType);

  const hasConsultDecision = (() => {
  if (needsDeviceFlow(ctx.contractType)) return !!ctx.payType;
  return true;
})();

if (hasConsultDecision){
  const startId = decideS3StartId(ctx);
  const startIdx = steps.findIndex(s => s.id === startId);
  if (startIdx >= 0){
    const shared = ensureLines();
    shared.lines[activeLine].flow.stepId = startId;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));
  }
}

  const savedId = (line.flow && line.flow.stepId) ? line.flow.stepId : "S1";
  let newIdx = steps.findIndex(s => s.id === savedId);
  if (newIdx < 0) newIdx = 0;
  idx = Math.max(0, Math.min(newIdx, steps.length - 1));

  restoreCheckStatesFromLine(line);

  render();
  renderLinebar();
  updateContractHolderOptions();
  updateS2UI();
}

const watchIds = [
  "contractType","contractHolder",
  "userRelation",
  "carrier","dataUsage",
  "homeNetType"
]

/* =========================
   Events
   ========================= */
watchIds.forEach(id => {
  const node = el(id);
  if (!node) return;
  node.addEventListener("change", () => {
    if (id === "contractType") updateTradeInVisibility();

    syncUserRelationLock();
    syncNewDeviceLocks();
    updateStartEnabled();
    saveDraft();
    node.classList.add("isSelected","pop");
    setTimeout(() => node.classList.remove("pop"), 220);
    if ((node.value || "").trim() === "") node.classList.remove("isSelected");
  });
});

["chk_id_confirmed","chk_homeNet_asked","chk_tradein"].forEach(id => {
  const node = el(id);
  if (!node) return;
  node.addEventListener("change", () => {
    updateStartEnabled();
    saveDraft();
  });
});

["s2PayType","s2NeedDataTransfer","s2NeedTradeInReception"].forEach(id=>{
  const node = el(id);
  if (!node) return;
  node.addEventListener("change", ()=>{
    const patch = {};
    if (id === "s2PayType") patch.payType = node.value || "";
    if (id === "s2NeedDataTransfer") patch.needDataTransfer = node.value || "no";
    if (id === "s2NeedTradeInReception") patch.needTradeInReception = node.value || "no";
    saveS2ConsultPatch(patch);

    syncFromStorage();
  });
});

el("s2ToCarrier")?.addEventListener("change", ()=>{
  const v = el("s2ToCarrier").value || "";
  // ã‚­ãƒ£ãƒªã‚¢å¤‰æ›´ â†’ ãƒ—ãƒ©ãƒ³ã¯ãƒªã‚»ãƒƒãƒˆ
  saveS2ConsultPatch({ toCarrier: v, toPlanKey: "" });

  renderS2ToPlanOptions(v, "");
  // stepsè‡ªä½“ã¯å¤‰ã‚ã‚‰ãªã„ã®ã§ syncFromStorage() ã¾ã§ã¯ä¸è¦ã€ã§ã‚‚ä¸€è¦§ã‚’æ›´æ–°ã—ãŸã„ãªã‚‰å‘¼ã‚“ã§OK
  syncFromStorage();
});

el("s2ToPlanKey")?.addEventListener("change", ()=>{
  const v = el("s2ToPlanKey").value || "";
  saveS2ConsultPatch({ toPlanKey: v });
  syncFromStorage();
});

["chk_s3sim_mnp","chk_s3sim_docs","chk_s3sim_input","chk_s3sim_notice"].forEach(id => {
  const node = el(id);
  if (!node) return;
  node.addEventListener("change", () => {
    saveChecklistToLine();
    if (steps[idx] && steps[idx].id === "S3" && ctx && ctx.contractType === "mnpSim") render();
  });
});

["chk_s3n_mnp","chk_s3n_apply","chk_s3n_prepare","chk_s3n_input","chk_s3n_video","chk_s3n_result"].forEach(id => {
  const node = el(id);
  if (!node) return;
  node.addEventListener("change", () => {
    saveChecklistToLine();
    if (steps[idx] && steps[idx].id === "S3N") render();
  });
});

["chk_done_return","chk_done_open","chk_done_datatransfer","chk_done_point","chk_done_consent","chk_done_tradein","chk_done_car"]
  .forEach(id => {
    const node = el(id);
    if (!node) return;
    node.addEventListener("change", () => {
      saveChecklistToLine();
      if (steps[idx] && steps[idx].id === "S4") render();
    });
  });

if (el("tradeinResult")){
  el("tradeinResult").addEventListener("change", () => {
    updateStartEnabled();
    saveDraft();
  });
}

if (el("addLineBtn")){
  el("addLineBtn").onclick = () => {
    saveDraft(); saveFlowState(); saveChecklistToLine();

    const shared = ensureLines();
    const keep = shared.activeLine;
    shared.lines.push(blankLine());
    shared.activeLine = keep; 
    localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));

    syncFromStorage();
  };
}

if (el("removeLineBtn")){
  el("removeLineBtn").onclick = () => {
    const shared = ensureLines();
    if (shared.lines.length <= 1) return;

    shared.lines.splice(activeLine, 1);
    shared.activeLine = Math.max(0, Math.min(activeLine, shared.lines.length - 1));
    localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));

    syncFromStorage();
  };
}

// start/reset
el("startBtn").onclick = () => {
  if (!allSelected()) return;

  const shared = ensureLines();
  const line = shared.lines[activeLine];

// é–‹å§‹æ™‚ï¼šã“ã®å›ç·šã®è³¼å…¥æ–¹æ³•ã ã‘ãƒªã‚»ãƒƒãƒˆ
  line.consult = { payType:"", needDataTransfer:"no", needTradeInReception:"no" };

  ctx = {
    ...collectForm(),
    payType: "",
    needDataTransfer: "no",
    needTradeInReception: "no",
  };

  steps = buildSteps(ctx.contractType, ctx.payType);
  idx = 0;

  line.flow = { started:true, stepId:"S1" };

  localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));
  render();
  renderLinebar();
};

el("resetBtn").onclick = () => {
  const shared = ensureLines();

  shared.lines[activeLine] = blankLine();
  shared.houseNet = { homeNetType:""};
  localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));

  ctx = null; steps = []; idx = -1;
  syncFromStorage();
};

el("wipeAllBtn").onclick = () => {
  // ç¢ºèª
  if (!confirm("å…¨å›ç·šãƒ»ä¸–å¸¯å…±é€šã‚’å«ã‚ã€å…¥åŠ›ã¨é€²æ—ã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

  localStorage.removeItem(STORAGE_KEY);
  ctx = null; steps = []; idx = -1;
  activeLine = 0;

  // åˆæœŸçŠ¶æ…‹ã‚’ä½œã‚Šç›´ã—ã¦æç”»
  syncFromStorage();
};

// nav
el("backBtn").onclick = () => { if (idx > 0) 
{ idx--; 
  saveFlowState(); 
  render(); 
} };
el("nextBtn").onclick = () => { if (idx < steps.length - 1) 
{ idx++; 
  saveFlowState();
  render();
} };

// help
if (el("helpBtn")){
  el("helpBtn").onclick = () => {
    window.location.href = "Readme.html";
  };
}

// bfcache / tab / storage
window.addEventListener("pageshow", () => syncFromStorage());
window.addEventListener("focus", () => syncFromStorage());
window.addEventListener("storage", (ev) => { if (ev.key === STORAGE_KEY) syncFromStorage(); });

/* =========================
   Init
   ========================= */
updateTradeInVisibility();
syncUserRelationLock();
syncNewDeviceLocks();
updateStartEnabled();
syncFromStorage();
</script>
<nav class="appSwitch" aria-label="ã‚¢ãƒ—ãƒªåˆ‡æ›¿">
  <a href="ContractNavigator.html" class="on" title="å¥‘ç´„ãƒŠãƒ“">ğŸ“‹</a>
  <a href="CarrierPalette.html" title="ã‚­ãƒ£ãƒªã‚¢ãƒ‘ãƒ¬ãƒƒãƒˆ">ğŸ“±</a>
  <a href="BBNavigator.html" title="BBãƒŠãƒ“">ğŸ </a>
</nav>
</body>
</html>